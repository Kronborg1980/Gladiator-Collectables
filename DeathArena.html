<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gladiators Death Arena: Sudden Death Tournament</title>
    <!-- Custom Fonts: Orbitron for titles, Bebas Neue for strong text/numbers, Roboto Mono for console text -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Bebas+Neue&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- VISUAL CONFIGURATION --- */
        :root {
            --primary-glow: #00ffea; /* Cyan neon */
            --secondary-glow: #ff00ff; /* Magenta neon */
            --bg-dark: #0a0e1f; /* Deep space blue */
            --text-light: #f0f0f0; /* Soft white */
            --neon-red: #ff4500; /* Rusty neon orange-red (Danger) */
            --neon-green: #00ff85; /* Bright green (Healing/Success) */
            --grid-color-dark: #1a2333; /* Darker grid */
            --card-bg: rgba(10, 14, 31, 0.95);
            --border-radius: 12px;
            --spacing-sm: 12px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --attack-color: #ff00ff; /* Magenta */
            --defense-color: #00ffea; /* Cyan */
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes scanlines { 0% { background-position: 0 0; } 100% { background-position: 0 50em; } }
        @keyframes flicker {
            0%, 18%, 22%, 25%, 53%, 57%, 100% { text-shadow: 0 0 15px var(--primary-glow), 0 0 20px var(--primary-glow); }
            20%, 24%, 55% { text-shadow: none; }
            58% { text-shadow: 0.5px 0 1px var(--secondary-glow), -0.5px 0 1px var(--neon-red); }
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 10px var(--primary-glow); }
            50% { box-shadow: 0 0 20px var(--secondary-glow); }
            100% { box-shadow: 0 0 10px var(--primary-glow); }
        }
        @keyframes damage-shake {
            0%, 100% { transform: translate(0); }
            25% { transform: translate(-5px, 0); }
            75% { transform: translate(5px, 0); }
        }
        @keyframes score-grow {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1.1); opacity: 1; }
        }
        @keyframes neon-firework {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.1); text-shadow: 0 0 30px var(--neon-green), 0 0 50px var(--neon-green); }
            100% { opacity: 1; transform: scale(1); }
        }
        

        /* --- CORE LAYOUT --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at center, #0c1426, var(--bg-dark));
            color: var(--text-light);
            font-family: 'Roboto Mono', monospace;
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; opacity: 0.08;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.5) 50%), repeating-linear-gradient(transparent, transparent 1px, rgba(0, 0, 0, 0.15) 1px, rgba(0, 0, 0, 0.15) 2px);
            background-size: 100% 2px, 2px 2px;
            animation: scanlines 6s linear infinite;
        }

        #mainContainer {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: clamp(var(--spacing-sm), 4vw, var(--spacing-md));
            max-width: 1600px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        /* --- TITLE --- */
        #titleContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-md);
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-glow);
            animation: flicker 4s linear infinite;
            letter-spacing: 4px;
            margin: 0;
            text-transform: uppercase;
            font-size: clamp(1.8em, 4vw, 3em);
            text-align: center;
            outline: 2px solid var(--primary-glow);
            padding: 8px 24px;
            border-radius: var(--border-radius);
            background: var(--card-bg);
            z-index: 100;
        }

        /* --- SETUP PAGE --- */
        #setupScreen {
            max-width: 900px; /* Wider for list display */
            width: 90%;
            margin: var(--spacing-lg) auto;
            padding: var(--spacing-lg);
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 2px solid var(--primary-glow);
            box-shadow: 0 0 20px var(--primary-glow);
            text-align: center;
            animation: pulse-glow 8s ease-in-out infinite;
        }
        #setupScreen h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--secondary-glow);
            text-shadow: 0 0 12px var(--secondary-glow);
            margin: 0 0 var(--spacing-md);
            font-size: clamp(1.4em, 3vw, 2.2em);
        }
        .input-card {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--primary-glow);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: inset 0 0 8px rgba(0, 255, 234, 0.2);
            text-align: left;
            margin-bottom: var(--spacing-md);
        }
        .input-card label {
            color: var(--text-light);
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: var(--spacing-sm);
            display: block;
        }
        .input-card textarea {
            width: 100%;
            min-height: 100px;
            background: var(--bg-dark);
            color: var(--text-light);
            border: 1px solid var(--primary-glow);
            padding: var(--spacing-sm);
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 1em;
            resize: vertical;
            box-sizing: border-box;
        }

        /* --- GAME BUTTONS --- */
        .game-button {
            padding: 12px 28px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            font-weight: bold;
            text-transform: uppercase;
            background: linear-gradient(45deg, var(--primary-glow), var(--secondary-glow));
            color: var(--bg-dark);
            box-shadow: 0 0 12px rgba(0, 255, 234, 0.3);
            transition: all 0.3s ease;
            min-width: 180px;
        }
        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px var(--primary-glow);
            filter: brightness(1.2);
        }
        .game-button.secondary {
            background: linear-gradient(45deg, var(--neon-red), #ff9900);
            color: var(--text-light);
            box-shadow: 0 0 12px var(--neon-red);
        }

        /* --- GAME SCREEN --- */
        #gameScreen {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            padding-top: var(--spacing-md);
        }
        /* Top Status Bar - Now fixed below the title in the game screen */
        #statusConsole {
            background: var(--bg-dark);
            border: 1px solid var(--secondary-glow);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 1em;
            color: var(--primary-glow);
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 10px var(--secondary-glow);
            margin-bottom: var(--spacing-md);
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        /* Status Bar in Setup Screen */
        #setupStatus {
            color: var(--primary-glow); 
            margin-bottom: var(--spacing-md);
        }

        #arena {
            display: flex;
            justify-content: center; /* Center the single duel zone */
            gap: var(--spacing-md);
            flex-grow: 1;
            margin-bottom: var(--spacing-md);
        }
        
        /* --- DUEL ZONE --- */
        #duelZone {
            /* Flex grow is still used to occupy available vertical space if needed */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            padding: var(--spacing-md);
            background: rgba(0, 0, 0, 0.5);
            border-radius: var(--border-radius);
            border: 3px solid var(--secondary-glow);
            box-shadow: 0 0 30px var(--secondary-glow);
            position: relative;
            max-width: 800px; /* Constraint duel zone size on large screens */
        }
        
        #roundDisplay {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3em;
            color: var(--primary-glow);
            text-shadow: 0 0 15px var(--primary-glow);
            margin: var(--spacing-sm) 0;
            line-height: 1;
        }
        #actionSlots {
            display: flex;
            gap: var(--spacing-lg);
            margin: var(--spacing-md) 0;
            z-index: 10;
        }
        .action-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 200px; 
            height: 250px;
            border-radius: var(--border-radius);
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
            position: relative;
            transition: all 0.3s ease;
            text-align: center;
            border: 2px dashed #444;
        }
        .action-slot h4 {
            font-family: 'Orbitron', sans-serif;
            margin: 0 0 5px 0;
            font-size: 1.2em;
            text-transform: uppercase;
        }
        .action-slot.winner {
            border-color: var(--neon-green);
            box-shadow: 0 0 25px var(--neon-green);
        }
        .action-slot.loser {
            border-color: var(--neon-red);
            box-shadow: 0 0 15px var(--neon-red);
            opacity: 0.5;
        }
        .slot-card-image {
            width: 120px;
            height: 120px;
            image-rendering: pixelated;
        }
        .slot-card-info {
            font-size: 0.8em;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
        }
        .luck-score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5em;
            color: var(--secondary-glow);
            text-shadow: 0 0 10px var(--secondary-glow);
            margin-top: 5px;
            line-height: 1;
            animation: score-grow 0.5s ease-out;
        }
        
        /* Match Detail Console */
        #matchDetails {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm);
            background: var(--bg-dark);
            border: 1px solid var(--primary-glow);
            border-radius: 8px;
            width: 90%;
            text-align: left;
            font-size: 0.9em;
            box-shadow: 0 0 10px var(--primary-glow);
            font-family: 'Roboto Mono', monospace;
        }
        .score-line {
            padding: 3px 0;
            border-bottom: 1px dotted rgba(255, 255, 255, 0.1);
        }
        .score-line:last-child { border-bottom: none; }
        .score-p1 { color: var(--primary-glow); }
        .score-p2 { color: var(--secondary-glow); }
        .type-adj { color: var(--neon-green); font-weight: bold; }
        .type-disadj { color: var(--neon-red); font-weight: bold; }


        /* --- TOURNAMENT LIST & POKEMON CARDS (Same on Setup & Game screens) --- */
        #tournamentListContainer {
            margin-top: var(--spacing-md);
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--primary-glow);
            border-radius: var(--border-radius);
            padding: var(--spacing-sm);
            background: rgba(0, 0, 0, 0.5);
            text-align: left;
        }
        #tournamentListContainer h4 {
            font-family: 'Orbitron', sans-serif;
            color: var(--secondary-glow);
            margin: 0 0 10px;
            text-align: center;
        }
        #contenderList {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        .contender-card-item {
            width: 120px;
            padding: 5px;
            background: var(--card-bg);
            border: 2px solid var(--secondary-glow);
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 0 8px var(--secondary-glow);
            transition: all 0.3s;
        }
        .contender-card-item.contender-eliminated {
            border-color: var(--neon-red);
            box-shadow: 0 0 5px var(--neon-red);
            opacity: 0.4;
            text-decoration: line-through;
        }
        .contender-card-item h5 {
            margin: 0 0 5px;
            font-size: 1em;
            color: var(--neon-green);
            font-family: 'Bebas Neue', sans-serif;
        }
        .contender-card-item img {
            width: 60px;
            height: 60px;
            image-rendering: pixelated;
        }
        .contender-card-item .type-badge {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6em;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
            text-transform: uppercase;
        }
        .type-badge.Fire { background-color: #ff4500; color: white; }
        .type-badge.Water { background-color: #00aaff; color: white; }
        .type-badge.Grass { background-color: #00ff85; color: black; }
        .type-badge.Electric { background-color: #fffb00; color: black; }
        .type-badge.Ground { background-color: #964b00; color: white; }
        .type-badge.Psychic { background-color: #ff00ff; color: white; }
        .type-badge.Normal { background-color: #aaaaaa; color: black; }
        .type-badge.Flying { background-color: #b0e0e6; color: black; }


        /* --- WINNER OVERLAY --- */
        #winnerOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--primary-glow);
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px var(--primary-glow);
            z-index: 2000;
            animation: pulse-glow 2s ease-in-out infinite;
        }
        #winnerOverlay h2 {
            font-size: clamp(3em, 8vw, 5em);
            color: var(--secondary-glow);
            text-shadow: 0 0 15px var(--secondary-glow), 0 0 25px var(--secondary-glow);
            margin: 0 0 10px;
            animation: neon-firework 2s ease-out both;
        }
        #winnerName {
            font-size: clamp(4em, 10vw, 7em);
            color: var(--neon-green);
            text-shadow: 0 0 20px var(--neon-green), 0 0 40px var(--neon-green), 0 0 60px var(--neon-green);
            font-family: 'Bebas Neue', sans-serif;
            font-weight: bold;
            letter-spacing: 6px;
            text-transform: uppercase;
            animation: neon-firework 2s ease-out 0.5s both;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 1024px) {
            #arena {
                flex-direction: column;
                align-items: center;
            }
            .action-slot {
                width: 150px;
                height: 200px;
            }
            .slot-card-image {
                width: 90px;
                height: 90px;
            }
        }
        @media (max-width: 640px) {
            .action-slot {
                width: 120px;
                height: 180px;
            }
            .slot-card-image {
                width: 70px;
                height: 70px;
            }
            .contender-card-item {
                width: 100px;
            }
            #actionSlots {
                gap: var(--spacing-sm);
            }
        }
    </style>
</head>
<body>
    <audio id="explosionSound" src="https://freesound.org/data/previews/171/171671_3025331-lq.mp3"></audio>

    <div id="mainContainer">
        <div id="titleContainer">
            <h1>GLADIATORS DEATH ARENA: SUDDEN DEATH TOURNAMENT</h1>
        </div>

        <!-- SETUP SCREEN -->
        <div id="setupScreen">
            <h2>TOURNAMENT REGISTRATION & POKÉMON ASSIGNMENT</h2>
            <div class="input-card">
                <label for="contenderNames">Enter Contender Names (one per line, min 2):</label>
                <textarea id="contenderNames" rows="5" placeholder=""></textarea>
            </div>
            
            <div id="tournamentListContainer" style="display: none;">
                <h4>TOURNAMENT BRACKET</h4>
                <ul id="contenderList"></ul>
            </div>
            
            <div id="setupStatus" style="color: var(--primary-glow); margin-bottom: var(--spacing-md);">Enter contenders and press SHUFFLE POKÉMONS.</div>
            
            <div style="display: flex; gap: var(--spacing-md); justify-content: center;">
                <button id="shufflePokemonsButton" class="game-button secondary">SHUFFLE POKÉMONS</button>
                <button id="selectPlayersButton" class="game-button">BEGIN TOURNAMENT</button>
            </div>
            
            <button onclick="resetGame()" class="game-button secondary" style="margin-top: var(--spacing-md);">RESET ARENA</button>
        </div>

        <!-- GAME SCREEN -->
        <div id="gameScreen">
            <!-- Consolidated Status Bar at the top of the game screen (relies on #setupStatus element) -->
            <div id="statusConsole"></div>

            <div id="arena">
                <!-- DUEL ZONE (Centered) -->
                <div id="duelZone">
                    <div id="roundDisplay">MATCH 1 / ROUND 1</div>

                    <div id="actionSlots">
                        <!-- P1 Card Slot -->
                        <div id="p1DuelSlot" class="action-slot">
                            <h4>CONTENDER 1</h4>
                            <img class="slot-card-image" src="" alt="P1 Pokemon" style="display: none;">
                            <div class="slot-card-info"></div>
                            <div class="luck-score" id="p1LuckScore">---</div>
                        </div>

                        <h2 style="font-family: 'Orbitron', sans-serif; color: var(--neon-red); text-shadow: 0 0 10px var(--neon-red); margin: 0;">VS</h2>

                        <!-- P2 Card Slot -->
                        <div id="p2DuelSlot" class="action-slot">
                            <h4>CONTENDER 2</h4>
                            <img class="slot-card-image" src="" alt="P2 Pokemon" style="display: none;">
                            <div class="slot-card-info"></div>
                            <div class="luck-score" id="p2LuckScore">---</div>
                        </div>
                    </div>

                    <!-- Match Detail Console -->
                    <div id="matchDetails">
                        Waiting for match resolution...
                    </div>

                    <!-- Elimination Message -->
                    <h2 id="eliminationMessage" style="color: var(--neon-red); display: none;"></h2>
                </div>
            </div>
        </div>

        <!-- WINNER OVERLAY -->
        <div id="winnerOverlay">
            <h2>TOURNAMENT CHAMPION EMERGES!</h2>
            <span id="winnerName"></span>
            <button onclick="resetGame()" class="game-button" style="margin-top: var(--spacing-lg);">START NEW TOURNAMENT</button>
        </div>
    </div>

    <script>
        const setupScreen = document.getElementById('setupScreen');
        const gameScreen = document.getElementById('gameScreen');
        const winnerOverlay = document.getElementById('winnerOverlay');
        const statusConsole = document.getElementById('statusConsole'); // Now the top bar in game view
        const setupStatus = document.getElementById('setupStatus'); // Status bar in setup view
        const shufflePokemonsButton = document.getElementById('shufflePokemonsButton');
        const selectPlayersButton = document.getElementById('selectPlayersButton');
        const roundDisplay = document.getElementById('roundDisplay');
        const explosionSound = document.getElementById('explosionSound');
        const contenderListUl = document.getElementById('contenderList');
        const tournamentListContainer = document.getElementById('tournamentListContainer');
        const eliminationMessage = document.getElementById('eliminationMessage');
        const matchDetails = document.getElementById('matchDetails');

        // Duel Slot Elements
        const p1DuelSlot = document.getElementById('p1DuelSlot');
        const p2DuelSlot = document.getElementById('p2DuelSlot'); 
        const p1LuckScoreDisplay = document.getElementById('p1LuckScore');
        const p2LuckScoreDisplay = document.getElementById('p2LuckScore');
        const p1NameDisplay = document.getElementById('player1Name');
        const p2NameDisplay = document.getElementById('player2Name');

        // --- GLOBAL GAME STATE ---
        const MATCH_DELAY_MS = 2500; 

        let gameActive = false;
        let tournamentRound = 0;
        let matchNumber = 0;

        // Tournament specific state
        let allContenders = []; 
        let activeContendersQueue = []; 
        let currentMatch = {}; 

        // --- POKEMON DATA & RULES ---
        const POKEMON_TYPES = ['Fire', 'Water', 'Grass', 'Electric', 'Ground', 'Psychic', 'Normal', 'Flying'];
        const ALL_POKEMON_COUNT = 151;
        let POKEMON_SPRITE_DATA = []; 

        // Simplified Type Chart
        const TYPE_CHART = {
            'Fire': { SE: ['Grass'], NE: ['Fire', 'Water', 'Ground'] },
            'Water': { SE: ['Fire', 'Ground'], NE: ['Water', 'Grass'] },
            'Grass': { SE: ['Water', 'Ground'], NE: ['Fire', 'Grass', 'Flying'] },
            'Electric': { SE: ['Water', 'Flying'], NE: ['Electric', 'Grass', 'Ground'] },
            'Ground': { SE: ['Electric', 'Fire'], NE: ['Grass', 'Flying'] },
            'Psychic': { SE: ['Fighting', 'Poison'], NE: ['Psychic'] },
            'Normal': { SE: [], NE: ['Ground'] },
            'Flying': { SE: ['Grass', 'Fighting'], NE: ['Electric', 'Flying'] }
        };
        
        // Returns point adjustments based on match-up
        function getTypeAdjustment(attackingType, defendingType) {
            const chart = TYPE_CHART[attackingType];
            if (!chart) return 0; // Neutral

            if (chart.SE.includes(defendingType)) {
                return 50; // Super Effective: Major Advantage
            }
            if (chart.NE.includes(defendingType)) {
                return -30; // Not Effective: Major Disadvantage
            }
            return 0; // Neutral
        }


        function initializePokemonData() {
            POKEMON_SPRITE_DATA = [];
            let powers = [];
            let types = [];
            for(let i = 0; i < ALL_POKEMON_COUNT; i++) {
                // Power is for tiebreaker only (50-100)
                powers.push(Math.floor(Math.random() * 50) + 50); 
                types.push(POKEMON_TYPES[i % POKEMON_TYPES.length]); 
            }
            powers = shuffleArray(powers);
            types = shuffleArray(types);

            for (let id = 1; id <= ALL_POKEMON_COUNT; id++) {
                POKEMON_SPRITE_DATA.push({
                    id: id,
                    name: `Poke ${id}`,
                    type: types[id - 1],
                    power: powers[id - 1],
                    spriteUrl: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${id}.gif`,
                });
            }
            POKEMON_SPRITE_DATA = shuffleArray(POKEMON_SPRITE_DATA);
            updateStatus('Pokémon attributes initialized. Enter contenders.');
        }

        function shufflePokemons() {
            if (gameActive) return;
            initializePokemonData();
            // If contenders are already registered, re-assign their Pokemon
            if (allContenders.length > 0) {
                const shuffledPokemonData = shuffleArray([...POKEMON_SPRITE_DATA]);
                allContenders.forEach((contender, index) => {
                    contender.pokemon = shuffledPokemonData[index % shuffledPokemonData.length];
                });
                updateContenderList();
            }
            updateStatus('Pokémon Types and Powers have been SHUFFLED. Ready to start tournament.');
        }

        // --- UTILITY FUNCTIONS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function playExplosion() {
            document.body.style.animation = 'damage-shake 0.2s 3';
            setTimeout(() => document.body.style.animation = 'none', 600);
            explosionSound.currentTime = 0;
            explosionSound.play().catch(e => console.error("Audio playback failed:", e));
        }

        function updateStatus(message, isError = false) {
            const element = gameScreen.style.display === 'flex' ? statusConsole : setupStatus;
            element.innerHTML = message;
            element.style.borderColor = isError ? 'var(--neon-red)' : 'var(--secondary-glow)';
            element.style.boxShadow = isError ? '0 0 10px var(--neon-red)' : '0 0 10px var(--secondary-glow)';
        }

        // --- POKEMON AND CARD DISPLAY ---

        function updateDuelSlot(element, contender) {
            const img = element.querySelector('.slot-card-image');
            img.src = contender.pokemon.spriteUrl;
            img.alt = contender.pokemon.name;
            img.style.display = 'block';

            element.querySelector('h4').textContent = contender.name;
            
            const info = element.querySelector('.slot-card-info');
            // Show the generic 'Poke X' name below the contender's name
            info.innerHTML = `
                <div class="card-type ${contender.pokemon.type}" style="font-size: 1.2em; font-family: 'Bebas Neue', sans-serif;">${contender.pokemon.name}</div>
                <div class="type-badge ${contender.pokemon.type}">TYPE: ${contender.pokemon.type}</div>
                <div style="font-size: 0.7em;">PWR: ${contender.pokemon.power}</div>
            `;
            element.classList.remove('winner', 'loser');
            element.querySelector('.luck-score').textContent = '---';
        }

        function clearDuelSlots() {
            [p1DuelSlot, p2DuelSlot].forEach(slot => {
                slot.classList.remove('winner', 'loser');
                slot.querySelector('.luck-score').textContent = '---';
            });
            eliminationMessage.style.display = 'none';
            matchDetails.innerHTML = 'Waiting for match resolution...';
        }
        
        function updateContenderList() {
            const namesInput = document.getElementById('contenderNames').value.split('\n').map(n => n.trim()).filter(n => n);
            if (allContenders.length === 0 && namesInput.length >= 2) {
                setupTournament(true); 
            }

            tournamentListContainer.style.display = 'block';
            contenderListUl.innerHTML = '';

            allContenders.filter(c => c.active || !c.active).forEach(c => { 
                const div = document.createElement('div');
                div.className = `contender-card-item ${c.active ? 'contender-active' : 'contender-eliminated'}`;
                
                div.innerHTML = `
                    <h5>${c.name}</h5>
                    <img src="${c.pokemon.spriteUrl}" alt="${c.pokemon.name}">
                    <div class="type-badge ${c.pokemon.type}">${c.pokemon.type}</div>
                `;
                contenderListUl.appendChild(div);
            });
            
            setupStatus.textContent = `Total Contenders: ${allContenders.filter(c => c.active).length} active. SHUFFLE or BEGIN.`;
        }

        // --- TOURNAMENT FLOW ---
        
        function setupTournament(isInitialSetup = false) {
            const namesInput = document.getElementById('contenderNames').value.split('\n').map(n => n.trim()).filter(n => n);
            if (namesInput.length < 2) {
                setupStatus.textContent = 'ERROR: Need at least two contender names.';
                return;
            }

            if (isInitialSetup || allContenders.length !== namesInput.length) {
                const shuffledPokemonData = shuffleArray([...POKEMON_SPRITE_DATA]);
                allContenders = namesInput.map((name, index) => ({
                    name: name,
                    pokemon: shuffledPokemonData[index % shuffledPokemonData.length],
                    active: true
                }));
            }
            
            activeContendersQueue = allContenders.filter(c => c.active);
            
            updateContenderList();
            updateStatus('Contenders registered. Press BEGIN TOURNAMENT.');
        }

        function getRoundName(round) {
            if (round === 0) return "THE GAUNTLET";
            const active = allContenders.filter(c => c.active).length;
            if (active <= 2) return "THE FINAL SHOWDOWN";
            if (active <= 4) return "THE SEMI-FINALS";
            if (active <= 8) return "THE QUARTER-FINALS";
            return `ROUND ${round + 1}`;
        }

        function beginTournament() {
             if (allContenders.filter(c => c.active).length < 2) {
                setupStatus.textContent = 'ERROR: Need at least two active contenders to start the tournament.';
                return;
            }

            tournamentRound = 0;
            matchNumber = 0;
            
            activeContendersQueue = shuffleArray(allContenders.filter(c => c.active));

            setupScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            document.getElementById('titleContainer').classList.add('game-active');
            
            // Move status content from setup bar to game bar
            statusConsole.innerHTML = setupStatus.innerHTML;

            scheduleNextMatch();
        }
        
        function scheduleNextMatch() {
            const activeCount = allContenders.filter(c => c.active).length;
            if (activeCount === 1) {
                endTournament(allContenders.find(c => c.active));
                return;
            } else if (activeCount === 0) {
                endTournament(null);
                return;
            }

            // Check if all matches in the current pairing set are done
            if (activeContendersQueue.length === 0) {
                let winners = allContenders.filter(c => c.active);
                
                // If the number of winners is odd, the first one gets a bye
                if (winners.length % 2 !== 0 && winners.length > 1) {
                     winners = shuffleArray(winners);
                     const byeContender = winners.pop();
                     winners.unshift(byeContender); 
                }
                
                activeContendersQueue = shuffleArray(winners);
                tournamentRound++;
                matchNumber = 0;
                
                // Announce new round prominently
                roundDisplay.textContent = getRoundName(tournamentRound);
                updateStatus(`ADVANCEMENT: Starting ${getRoundName(tournamentRound)}! ${activeContendersQueue.length} gladiators remain.`);
                setTimeout(scheduleNextMatch, MATCH_DELAY_MS * 1.5);
                return;
            }

            // Get next two players
            const p1 = activeContendersQueue.shift();
            const p2 = activeContendersQueue.shift();

            // Handle the bye scenario (only one player left in the queue)
            if (!p2 && p1) {
                 activeContendersQueue.unshift(p1); // Put the bye player back to be checked next time
                 scheduleNextMatch(); 
                 return;
            }
            if (!p1 || !p2) return; // Safety check

            matchNumber++;
            gameActive = true;
            
            currentMatch = { p1, p2, p1Pokemon: p1.pokemon, p2Pokemon: p2.pokemon };

            // Update UI with match info
            roundDisplay.textContent = `${getRoundName(tournamentRound)} | MATCH ${matchNumber}`;
            // Update the duel slot headers immediately for visual clarity
            p1DuelSlot.querySelector('h4').textContent = currentMatch.p1.name;
            p2DuelSlot.querySelector('h4').textContent = currentMatch.p2.name;

            updateDuelSlot(p1DuelSlot, currentMatch.p1);
            updateDuelSlot(p2DuelSlot, currentMatch.p2);
            
            clearDuelSlots();
            
            // Simplified status message to avoid visual clutter during the quick match resolution
            updateStatus(`BATTLE PROTOCOL: ${currentMatch.p1.name} (${currentMatch.p1Pokemon.type}) vs ${currentMatch.p2.name} (${currentMatch.p2Pokemon.type})`);

            setTimeout(resolveDuel, 1500); 
        }


        function resolveDuel() {
            // --- CORE BATTLE SCORE MECHANIC (Type Dependent) ---
            
            // 1. Initial Roll (Luck Factor 1 to 100)
            const p1Roll = Math.floor(Math.random() * 100) + 1;
            const p2Roll = Math.floor(Math.random() * 100) + 1;

            // 2. Type Match-up Adjustments (Attacker vs Defender Type)
            const p1TypeAdj = getTypeAdjustment(currentMatch.p1Pokemon.type, currentMatch.p2Pokemon.type);
            const p2TypeAdj = getTypeAdjustment(currentMatch.p2Pokemon.type, currentMatch.p1Pokemon.type);
            
            // 3. Power Bonus (Minor Tiebreaker, max +20)
            const p1PowerBonus = Math.round(currentMatch.p1Pokemon.power * 0.2);
            const p2PowerBonus = Math.round(currentMatch.p2Pokemon.power * 0.2);

            // 4. Final Battle Score Calculation
            const p1BattleScore = p1Roll + p1TypeAdj + p1PowerBonus;
            const p2BattleScore = p2Roll + p2TypeAdj + p2PowerBonus;

            let winnerContender, loserContender;

            if (p1BattleScore > p2BattleScore) {
                winnerContender = currentMatch.p1;
                loserContender = currentMatch.p2;
            } else if (p2BattleScore > p1BattleScore) {
                winnerContender = currentMatch.p2;
                loserContender = currentMatch.p1;
            } else {
                // Tiebreaker: Use the highest base Pokémon Power
                if (currentMatch.p1Pokemon.power > currentMatch.p2Pokemon.power) {
                    winnerContender = currentMatch.p1;
                    loserContender = currentMatch.p2;
                } else if (currentMatch.p2Pokemon.power > currentMatch.p1Pokemon.power) {
                    winnerContender = currentMatch.p2;
                    loserContender = currentMatch.p1;
                } else {
                    // Final tiebreaker: Random
                    const random = Math.random();
                    winnerContender = random > 0.5 ? currentMatch.p1 : currentMatch.p2;
                    loserContender = random <= 0.5 ? currentMatch.p1 : currentMatch.p2;
                }
            }

            // --- VISUAL RESOLUTION ---
            p1LuckScoreDisplay.textContent = Math.round(p1BattleScore);
            p2LuckScoreDisplay.textContent = Math.round(p2BattleScore);
            
            // Generate detailed match stats
            const adjClassP1 = p1TypeAdj > 0 ? 'type-adj' : p1TypeAdj < 0 ? 'type-disadj' : '';
            const adjClassP2 = p2TypeAdj > 0 ? 'type-adj' : p2TypeAdj < 0 ? 'type-disadj' : '';

            const detailMsg = `
                <div class="score-line score-p1">
                    <strong>${currentMatch.p1.name} (${currentMatch.p1Pokemon.type})</strong><br>
                    Base Roll: ${p1Roll} | Type Adj: <span class="${adjClassP1}">${p1TypeAdj > 0 ? '+' : ''}${p1TypeAdj}</span> | PWR Adj: +${p1PowerBonus}
                </div>
                <div class="score-line score-p2">
                    <strong>${currentMatch.p2.name} (${currentMatch.p2Pokemon.type})</strong><br>
                    Base Roll: ${p2Roll} | Type Adj: <span class="${adjClassP2}">${p2TypeAdj > 0 ? '+' : ''}${p2TypeAdj}</span> | PWR Adj: +${p2PowerBonus}
                </div>
            `;
            matchDetails.innerHTML = detailMsg;


            if (winnerContender === currentMatch.p1) {
                p1DuelSlot.classList.add('winner');
                p2DuelSlot.classList.add('loser');
            } else {
                p2DuelSlot.classList.add('winner');
                p1DuelSlot.classList.add('loser');
            }
            playExplosion();
            
            // Eliminate the loser
            const eliminatedIndex = allContenders.findIndex(c => c.name === loserContender.name);
            if (eliminatedIndex !== -1) {
                allContenders[eliminatedIndex].active = false;
            }
            
            // Show result
            eliminationMessage.textContent = `${loserContender.name} ELIMINATED! ${winnerContender.name} ADVANCES!`;
            eliminationMessage.style.display = 'block';
            eliminationMessage.style.color = 'var(--neon-green)';
            
            // --- FIX FOR WINNER ANNOUNCEMENT: Check immediately after elimination ---
            const remainingContenders = allContenders.filter(c => c.active);
            updateContenderList();
            
            if (remainingContenders.length === 1) {
                // Schedule endTournament instead of scheduleNextMatch
                setTimeout(() => endTournament(remainingContenders[0]), MATCH_DELAY_MS);
            } else {
                // Schedule the next match automatically
                setTimeout(scheduleNextMatch, MATCH_DELAY_MS);
            }
        }

        function endTournament(winner) {
            gameActive = false;
            
            document.getElementById('winnerName').textContent = winner ? winner.name : "DRAW";
            
            // Clear the game screen elements for a clean overlay display
            gameScreen.style.display = 'none';
            winnerOverlay.style.display = 'flex';
            
            // Final status update (only relevant if overlay wasn't full screen)
            updateStatus(`TOURNAMENT COMPLETE! ${winner ? winner.name : 'No one'} is the CHAMPION.`);
        }

        function resetGame() {
            gameActive = false;
            tournamentRound = 0;
            matchNumber = 0;
            setupScreen.style.display = 'block';
            gameScreen.style.display = 'none';
            winnerOverlay.style.display = 'none';
            document.getElementById('titleContainer').classList.remove('game-active');
            
            allContenders = [];
            activeContendersQueue = [];
            currentMatch = {};
            
            document.getElementById('contenderNames').value = ''; 
            selectPlayersButton.style.display = 'block';
            shufflePokemonsButton.style.display = 'block';
            tournamentListContainer.style.display = 'none';
            
            initializePokemonData();
            updateStatus('Enter contenders and press SHUFFLE POKÉMONS.');
            clearDuelSlots();
        }

        // --- EVENT LISTENERS ---
        selectPlayersButton.addEventListener('click', beginTournament);
        shufflePokemonsButton.addEventListener('click', shufflePokemons);
        document.getElementById('contenderNames').addEventListener('input', () => setupTournament(true));
        
        // Initial setup
        initializePokemonData();
        resetGame();

    </script>
</body>
</html>
