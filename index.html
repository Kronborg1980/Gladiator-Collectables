<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="utf-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  Â  <title>Gladiator Collectibles</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Bebas+Neue&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  :root{
Â  Â  Â  Â  Â  Â  --primary-glow: #e0e0e0;
Â  Â  Â  Â  Â  Â  --secondary-glow: #00eaff;
Â  Â  Â  Â  Â  Â  --bg-dark: #0a0a0a;
Â  Â  Â  Â  Â  Â  --text-light: #f0ff00;
Â  Â  Â  Â  Â  Â  --neutral-dark: #333;
Â  Â  Â  Â  Â  Â  --neutral-medium: #555;
Â  Â  Â  Â  Â  Â  --neutral-light: #bbb;
Â  Â  Â  Â  Â  Â  --track-color-dark: #1a1a1a;
Â  Â  Â  Â  Â  Â  --track-color-medium: #2a2a2a;
Â  Â  Â  Â  Â  Â  --track-color-light: #3a3a3a;
Â  Â  Â  Â  Â  Â  --finish-line-color-primary: #ffffff;
Â  Â  Â  Â  Â  Â  --finish-line-color-secondary: #000000;
Â  Â  Â  Â  Â  Â  --racer-name-color: #FFFFFF;
Â  Â  Â  Â  Â  Â  --prepare-color: #ff5500;
Â  Â  Â  Â  Â  Â  --surge-color: #ff0044;
Â  Â  Â  Â  Â  Â  --neon-red: #ff1744;
Â  Â  Â  Â  }
Â  Â  Â  Â  html,body{
Â  Â  Â  Â  Â  Â  height:100%;
Â  Â  Â  Â  Â  Â  margin:0;
Â  Â  Â  Â  Â  Â  padding:0;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #0d011a, var(--bg-dark), #010a14);
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  font-family: 'Bebas Neue', sans-serif;
Â  Â  Â  Â  Â  Â  -webkit-font-smoothing:antialiased;
Â  Â  Â  Â  Â  Â  -moz-osx-font-smoothing:grayscale;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ADDED CSS FOR CANVAS TEXT SHARPNESS */
Â  Â  Â  Â  #raceCanvas {
Â  Â  Â  Â  Â  Â  image-rendering: -webkit-optimize-contrast;
Â  Â  Â  Â  Â  Â  image-rendering: crisp-edges;
Â  Â  Â  Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  Â  Â  Â  -moz-osx-font-smoothing: grayscale;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* END ADDED CSS */
Â  Â  Â  Â  #titleContainer{
Â  Â  Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  Â  Â  flex-direction:column;
Â  Â  Â  Â  Â  Â  align-items:center;
Â  Â  Â  Â  Â  Â  justify-content:center;
Â  Â  Â  Â  Â  Â  margin: 18px 0 6px;
Â  Â  Â  Â  Â  Â  gap:6px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #logo{
Â  Â  Â  Â  Â  Â  width: clamp(60px, 12vw, 90px);
Â  Â  Â  Â  Â  Â  height:auto;
Â  Â  Â  Â  Â  Â  border-radius:12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px rgba(255,255,255,0.5), 0 0 25px var(--secondary-glow);
Â  Â  Â  Â  }
Â  Â  Â  Â  h1{
Â  Â  Â  Â  Â  Â  font-family:'Orbitron',sans-serif;
Â  Â  Â  Â  Â  Â  color: var(--secondary-glow);
Â  Â  Â  Â  Â  Â  text-shadow:0 0 15px var(--secondary-glow), 0 0 30px var(--secondary-glow);
Â  Â  Â  Â  Â  Â  letter-spacing:4px;
Â  Â  Â  Â  Â  Â  margin:0;
Â  Â  Â  Â  Â  Â  text-transform:uppercase;
Â  Â  Â  Â  Â  Â  font-size: clamp(1.6em, 3.8vw, 2.8em);
Â  Â  Â  Â  Â  Â  text-align:center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #frontPage{
Â  Â  Â  Â  Â  Â  max-width:950px;
Â  Â  Â  Â  Â  Â  margin:0 auto;
Â  Â  Â  Â  Â  Â  padding:20px;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, rgba(10,10,10,0.8), rgba(26,26,26,0.9));
Â  Â  Â  Â  Â  Â  border-radius:20px;
Â  Â  Â  Â  Â  Â  border:2px solid var(--secondary-glow);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 30px rgba(0,234,255,0.3);
Â  Â  Â  Â  Â  Â  text-align:center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #frontPage h2{
Â  Â  Â  Â  Â  Â  font-family:'Orbitron',sans-serif;
Â  Â  Â  Â  Â  Â  color: var(--secondary-glow);
Â  Â  Â  Â  Â  Â  text-shadow:0 0 10px var(--secondary-glow);
Â  Â  Â  Â  Â  Â  margin-bottom:20px;
Â  Â  Â  Â  Â  Â  letter-spacing:2px;
Â  Â  Â  Â  Â  Â  font-size:2em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .setup-grid{
Â  Â  Â  Â  Â  Â  display:grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
Â  Â  Â  Â  Â  Â  gap:20px;
Â  Â  Â  Â  Â  Â  margin-bottom:20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-card{
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.5);
Â  Â  Â  Â  Â  Â  border:1px solid var(--neutral-medium);
Â  Â  Â  Â  Â  Â  border-radius:12px;
Â  Â  Â  Â  Â  Â  padding:15px;
Â  Â  Â  Â  Â  Â  box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-card label{
Â  Â  Â  Â  Â  Â  display:block;
Â  Â  Â  Â  Â  Â  margin-bottom:8px;
Â  Â  Â  Â  Â  Â  color:var(--neutral-light);
Â  Â  Â  Â  Â  Â  font-size:0.9em;
Â  Â  Â  Â  Â  Â  font-weight:bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-card input, .input-card textarea{
Â  Â  Â  Â  Â  Â  width:100%;
Â  Â  Â  Â  Â  Â  background:var(--neutral-dark);
Â  Â  Â  Â  Â  Â  color:var(--text-light);
Â  Â  Â  Â  Â  Â  border:1px solid var(--secondary-glow);
Â  Â  Â  Â  Â  Â  padding:10px;
Â  Â  Â  Â  Â  Â  border-radius:6px;
Â  Â  Â  Â  Â  Â  font-size:1em;
Â  Â  Â  Â  Â  Â  box-sizing:border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-card textarea{
Â  Â  Â  Â  Â  Â  resize:vertical;
Â  Â  Â  Â  Â  Â  min-height:120px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .action-buttons{
Â  Â  Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  Â  Â  justify-content:center;
Â  Â  Â  Â  Â  Â  gap:15px;
Â  Â  Â  Â  Â  Â  margin:20px 0;
Â  Â  Â  Â  Â  Â  flex-wrap:wrap;
Â  Â  Â  Â  }
Â  Â  Â  Â  .race-button{
Â  Â  Â  Â  Â  Â  padding: 15px 35px;
Â  Â  Â  Â  Â  Â  border:none;
Â  Â  Â  Â  Â  Â  border-radius:10px;
Â  Â  Â  Â  Â  Â  cursor:pointer;
Â  Â  Â  Â  Â  Â  font-weight:bold;
Â  Â  Â  Â  Â  Â  font-size:1.1em;
Â  Â  Â  Â  Â  Â  transition: all 0.3s;
Â  Â  Â  Â  Â  Â  background: linear-gradient(45deg, var(--secondary-glow), #00aaff);
Â  Â  Â  Â  Â  Â  color:#111;
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(0,234,255,0.35), 0 0 20px rgba(0,234,255,0.1);
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 0 rgba(255,255,255,0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â  .race-button:hover{
Â  Â  Â  Â  Â  Â  transform:translateY(-3px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 25px rgba(0,234,255,0.5), 0 0 30px rgba(0,234,255,0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â  .race-button.prepare{
Â  Â  Â  Â  Â  Â  background: linear-gradient(45deg, var(--neon-red), #ff4081);
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(255, 23, 68, 0.6), 0 0 20px rgba(255, 23, 68, 0.3);
Â  Â  Â  Â  Â  Â  padding: 15px 35px;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .race-button:disabled{ cursor:not-allowed; opacity:0.6; transform:none; box-shadow:none; }
Â  Â  Â  Â  #status{
Â  Â  Â  Â  Â  Â  padding:12px;
Â  Â  Â  Â  Â  Â  background:rgba(0,234,255,0.1);
Â  Â  Â  Â  Â  Â  border:1px solid var(--secondary-glow);
Â  Â  Â  Â  Â  Â  border-radius:8px;
Â  Â  Â  Â  Â  Â  font-family: 'Orbitron', sans-serif;
Â  Â  Â  Â  Â  Â  font-size:1.1em;
Â  Â  Â  Â  Â  Â  color: var(--primary-glow);
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 6px var(--primary-glow);
Â  Â  Â  Â  Â  Â  margin-top:15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #submittedNames{
Â  Â  Â  Â  Â  Â  width:100%;
Â  Â  Â  Â  Â  Â  max-width:950px;
Â  Â  Â  Â  Â  Â  margin:20px auto;
Â  Â  Â  Â  Â  Â  padding:20px;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
Â  Â  Â  Â  Â  Â  border-radius:15px;
Â  Â  Â  Â  Â  Â  border:2px solid var(--secondary-glow);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(0,234,255,0.3), inset 0 0 10px rgba(0,0,0,0.5);
Â  Â  Â  Â  Â  Â  color:var(--text-light);
Â  Â  Â  Â  Â  Â  font-family: 'Orbitron', sans-serif;
Â  Â  Â  Â  Â  Â  font-size:1.1em;
Â  Â  Â  Â  Â  Â  text-align:center;
Â  Â  Â  Â  Â  Â  display:none;
Â  Â  Â  Â  }
Â  Â  Â  Â  #submittedNames h3{
Â  Â  Â  Â  Â  Â  margin:0 0 15px 0;
Â  Â  Â  Â  Â  Â  color: var(--secondary-glow);
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 10px var(--secondary-glow);
Â  Â  Â  Â  Â  Â  letter-spacing:2px;
Â  Â  Â  Â  Â  Â  font-size:1.4em;
Â  Â  Â  Â  Â  Â  text-transform:uppercase;
Â  Â  Â  Â  }
Â  Â  Â  Â  #submittedNames ul{
Â  Â  Â  Â  Â  Â  list-style:none;
Â  Â  Â  Â  Â  Â  padding:0;
Â  Â  Â  Â  Â  Â  margin:0;
Â  Â  Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  Â  Â  flex-wrap:wrap;
Â  Â  Â  Â  Â  Â  justify-content:center;
Â  Â  Â  Â  Â  Â  gap:10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #submittedNames li{
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.6);
Â  Â  Â  Â  Â  Â  border:1px solid var(--neutral-medium);
Â  Â  Â  Â  Â  Â  border-radius:8px;
Â  Â  Â  Â  Â  Â  padding:8px 15px;
Â  Â  Â  Â  Â  Â  min-width:120px;
Â  Â  Â  Â  Â  Â  text-align:center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  font-size:0.95em;
Â  Â  Â  Â  Â  Â  color: var(--racer-name-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  #submittedNames li:hover{
Â  Â  Â  Â  Â  Â  background: rgba(0,234,255,0.1);
Â  Â  Â  Â  Â  Â  border-color: var(--secondary-glow);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px rgba(0,234,255,0.4);
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  }
Â  Â  Â  Â  #raceView{
Â  Â  Â  Â  Â  Â  width:100%;
Â  Â  Â  Â  Â  Â  max-width:1400px;
Â  Â  Â  Â  Â  Â  margin:0 auto;
Â  Â  Â  Â  Â  Â  display:none;
Â  Â  Â  Â  Â  Â  min-width:300px;
            /* Added position:relative here to ensure children use it as the anchor */
            position: relative;
Â  Â  Â  Â  }
Â  Â  Â  Â  #raceView.fullscreen{
Â  Â  Â  Â  Â  Â  position:fixed;
Â  Â  Â  Â  Â  Â  top:50%;
Â  Â  Â  Â  Â  Â  left:50%;
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  width:85vw;
Â  Â  Â  Â  Â  Â  height:85vh;
Â  Â  Â  Â  Â  Â  max-width:none;
Â  Â  Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  Â  Â  flex-direction:column;
Â  Â  Â  Â  Â  Â  align-items:center;
Â  Â  Â  Â  Â  Â  justify-content:center;
Â  Â  Â  Â  Â  Â  background:var(--bg-dark);
Â  Â  Â  Â  Â  Â  z-index:1000;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 50px var(--secondary-glow), inset 0 0 20px rgba(0, 234, 255, 0.1);
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  }
        
        /* CORRECTED LOGO STYLES */
        .corner-logo {
            position: absolute;
            width: clamp(60px, 10vh, 75px);
            height: auto;
            border-radius: 8px;
            box-shadow: 0 0 12px rgba(255,255,255,0.5), 0 0 20px var(--secondary-glow);
            z-index: 1200;
            display: none; /* Hide by default */
        }

        #raceView.fullscreen .corner-logo {
            display: block; /* Show only when raceView is fullscreen */
        }

        #logo-tl { top: 20px; left: 20px; }
        #logo-tr { top: 20px; right: 20px; }
        #logo-bl { bottom: 20px; left: 20px; }
        #logo-br { bottom: 20px; right: 20px; }
        /* END CORRECTED LOGO STYLES */

Â  Â  Â  Â  #raceControls {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  z-index: 1100;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  background: none;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  max-width: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .controls.hidden{ display:none; }
Â  Â  Â  Â  #leaderboard{
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  #leaderboard.fullscreen {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #0d011a, var(--bg-dark), #010a14);
Â  Â  Â  Â  Â  Â  z-index: 1500;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaderboard-content {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 700px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  max-height: 95vh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaderboard-content h3 {
Â  Â  Â  Â  Â  Â  font-family: 'Orbitron', sans-serif;
Â  Â  Â  Â  Â  Â  color: var(--secondary-glow);
Â  Â  Â  Â  Â  Â  font-size: 2.5em;
Â  Â  Â  Â  Â  Â  letter-spacing: 3px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 15px var(--secondary-glow);
Â  Â  Â  Â  }
Â  Â  Â  Â  #leaderboardList {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  border: 4px solid var(--secondary-glow);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 30px rgba(0, 234, 255, 0.8), inset 0 0 15px rgba(0, 234, 255, 0.4);
Â  Â  Â  Â  Â  Â  background: rgba(10, 10, 10, 0.8);
Â  Â  Â  Â  Â  Â  margin: 20px 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  overflow-y: visible;
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaderboard-entry {
Â  Â  Â  Â  Â  Â  background: #000000;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--neutral-medium);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 15px 25px;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  font-size: 1.4em;
Â  Â  Â  Â  Â  Â  font-family: 'Orbitron', sans-serif;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaderboard-entry.winner-entry {
Â  Â  Â  Â  Â  Â  border-color: var(--secondary-glow);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 25px var(--secondary-glow), inset 0 0 10px var(--secondary-glow);
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, #111111, rgba(0, 234, 255, 0.1), #111111);
Â  Â  Â  Â  Â  Â  color: var(--secondary-glow);
Â  Â  Â  Â  Â  Â  transform: scale(1.05);
Â  Â  Â  Â  Â  Â  font-size: 1.6em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .rank-number {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-right: 15px;
Â  Â  Â  Â  Â  Â  flex-basis: 10%;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  }
Â  Â  Â  Â  .racer-name-leaderboard {
Â  Â  Â  Â  Â  Â  flex-basis: 50%;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaderboard-entry.winner-entry .racer-name-leaderboard {
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 5px var(--secondary-glow);
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }
Â  Â  Â  Â  .time-result {
Â  Â  Â  Â  Â  Â  font-family: monospace;
Â  Â  Â  Â  Â  Â  color: var(--neutral-light);
Â  Â  Â  Â  Â  Â  flex-basis: 30%;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaderboard-entry.winner-entry .time-result {
Â  Â  Â  Â  Â  Â  color: var(--text-light);
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 5px var(--secondary-glow);
Â  Â  Â  Â  }
Â  Â  Â  Â  #postRaceControls {
Â  Â  Â  Â  Â  Â  margin-top: 40px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #winnerOverlay{
Â  Â  Â  Â  Â  Â  position:fixed;
Â  Â  Â  Â  Â  Â  top:0;
Â  Â  Â  Â  Â  Â  left:0;
Â  Â  Â  Â  Â  Â  width:100%;
Â  Â  Â  Â  Â  Â  height:100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(0,0,0,0.9);
Â  Â  Â  Â  Â  Â  color:var(--primary-glow);
Â  Â  Â  Â  Â  Â  font-family: 'Orbitron', sans-serif;
Â  Â  Â  Â  Â  Â  font-size: 4.5em;
Â  Â  Â  Â  Â  Â  display:none;
Â  Â  Â  Â  Â  Â  align-items:center;
Â  Â  Â  Â  Â  Â  justify-content:center;
Â  Â  Â  Â  Â  Â  flex-direction:column;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 25px var(--primary-glow);
Â  Â  Â  Â  Â  Â  z-index:2000;
Â  Â  Â  Â  }
Â  Â  Â  Â  #winnerName{ color: var(--secondary-glow); font-size:1.5em; margin-top:20px; text-transform:uppercase; text-shadow: 0 0 15px var(--secondary-glow); }
Â  Â  Â  Â  @media (max-width:700px){
Â  Â  Â  Â  Â  Â  .setup-grid { grid-template-columns: 1fr; }
Â  Â  Â  Â  Â  Â  .action-buttons { flex-direction:column; align-items:center; }
Â  Â  Â  Â  Â  Â  #submittedNames ul { flex-direction:column; align-items:center; }
Â  Â  Â  Â  Â  Â  .controls { padding: 12px; gap:10px; }
Â  Â  Â  Â  Â  Â  .leaderboard-entry { font-size: 1.1em; padding: 10px 15px; }
Â  Â  Â  Â  Â  Â  .rank-number { flex-basis: 15%; }
Â  Â  Â  Â  Â  Â  .racer-name-leaderboard { flex-basis: 45%; }
Â  Â  Â  Â  Â  Â  .time-result { flex-basis: 30%; font-size: 0.8em; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div id="titleContainer">
Â  Â  Â  Â  <img id="logo" src="https://60fb7b08eaf293096e8c.cdn6.editmysite.com/uploads/b/60fb7b08eaf293096e8cb3f63df9e65735b8a1ee75f6d23d21eaed2115dfa2e6/IMG_7388_1701827680.jpeg?width=2400&optimize=medium" alt="Gladiator Collectibles Logo">
Â  Â  Â  Â  <h1>GLADIATOR COLLECTIBLES</h1>
Â  Â  </div>
Â  Â  <div id="frontPage">
Â  Â  Â  Â  <h2>Race Setup</h2>
Â  Â  Â  Â  <div class="setup-grid">
Â  Â  Â  Â  Â  Â  <div class="input-card">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="raceTimeSeconds">Target Race Time (seconds):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="raceTimeSeconds" min="10" max="300" value="69">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="input-card">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="raceLengthDisplay">Target Finish Line (px):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="raceLengthDisplay" value="0" readonly title="The calculated finish line distance.">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="input-card" style="grid-column: span 2;">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="racerNames">Racer Names (one per line):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="racerNames" rows="5" placeholder="Ash\nMisty\nBrock\nGary\nLance"></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="action-buttons">
Â  Â  Â  Â  Â  Â  <button id="submitNamesButton" class="race-button">SUBMIT NAMES</button>
Â  Â  Â  Â  Â  Â  <button id="setupStartButton" class="race-button">START RACE</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="status">Systems nominal. Enter names (one per line), submit, and click 'START RACE' to begin.</div>
Â  Â  </div>
Â  Â  <div id="submittedNames">
Â  Â  Â  Â  <h3>Submitted Racers</h3>
Â  Â  Â  Â  <ul id="submittedNamesList"></ul>
Â  Â  </div>
Â  Â  <div id="raceView">
        Â  Â  Â  Â  <img class="corner-logo" id="logo-tl" src="https://60fb7b08eaf293096e8c.cdn6.editmysite.com/uploads/b/60fb7b08eaf293096e8cb3f63df9e65735b8a1ee75f6d23d21eaed2115dfa2e6/IMG_7388_1701827680.jpeg?width=2400&optimize=medium" alt="Gladiator Collectibles Logo">
Â  Â  Â  Â  <img class="corner-logo" id="logo-tr" src="https://60fb7b08eaf293096e8c.cdn6.editmysite.com/uploads/b/60fb7b08eaf293096e8cb3f63df9e65735b8a1ee75f6d23d21eaed2115dfa2e6/IMG_7388_1701827680.jpeg?width=2400&optimize=medium" alt="Gladiator Collectibles Logo">
Â  Â  Â  Â  <img class="corner-logo" id="logo-bl" src="https://60fb7b08eaf293096e8c.cdn6.editmysite.com/uploads/b/60fb7b08eaf293096e8cb3f63df9e65735b8a1ee75f6d23d21eaed2115dfa2e6/IMG_7388_1701827680.jpeg?width=2400&optimize=medium" alt="Gladiator Collectibles Logo">
Â  Â  Â  Â  <img class="corner-logo" id="logo-br" src="https://60fb7b08eaf293096e8c.cdn6.editmysite.com/uploads/b/60fb7b08eaf293096e8cb3f63df9e65735b8a1ee75f6d23d21eaed2115dfa2e6/IMG_7388_1701827680.jpeg?width=2400&optimize=medium" alt="Gladiator Collectibles Logo">
        Â  Â  Â  Â  <div id="raceControls" class="controls">
Â  Â  Â  Â  Â  Â  <button id="shuffleButton" class="race-button">SHUFFLE POKEMON</button>
Â  Â  Â  Â  Â  Â  <button id="raceScreenStartButton" class="race-button prepare">START RACE (GO!)</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <canvas id="raceCanvas"></canvas>
Â  Â  </div>
Â  Â  <div id="leaderboard">
Â  Â  Â  Â  <div class="leaderboard-content">
Â  Â  Â  Â  Â  Â  <div id="leaderboardTitle"></div>
Â  Â  Â  Â  Â  Â  <div id="leaderboardList"></div>
Â  Â  Â  Â  Â  Â  <div id="postRaceControls" class="controls" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="resetRace()" class="race-button" style="background: linear-gradient(45deg, #ff9900, #ff5500);">RETURN TO SETUP</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="winnerOverlay">
Â  Â  Â  Â  VICTORY!
Â  Â  Â  Â  <span id="winnerName"></span>
Â  Â  </div>
Â  Â  <script>
Â  Â  Â  Â  const canvas = document.getElementById('raceCanvas');
Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  const setupControls = document.getElementById('frontPage');
Â  Â  Â  Â  const raceView = document.getElementById('raceView');
Â  Â  Â  Â  const raceControls = document.getElementById('raceControls');
Â  Â  Â  Â  const postRaceControls = document.getElementById('postRaceControls');
Â  Â  Â  Â  const winnerOverlay = document.getElementById('winnerOverlay');
Â  Â  Â  Â  const leaderboard = document.getElementById('leaderboard');
Â  Â  Â  Â  const submitNamesButton = document.getElementById('submitNamesButton');
Â  Â  Â  Â  const setupStartButton = document.getElementById('setupStartButton');
Â  Â  Â  Â  const raceScreenStartButton = document.getElementById('raceScreenStartButton');
Â  Â  Â  Â  const shuffleButton = document.getElementById('shuffleButton');
Â  Â  Â  Â  const statusDisplay = document.getElementById('status');
Â  Â  Â  Â  let CANVAS_VIEWPORT_WIDTH, CANVAS_VIEWPORT_HEIGHT;
Â  Â  Â  Â  // MODIFIED: Increased anchor to 40% for better visual centering
Â  Â  Â  Â  const FIXED_RACER_X_ANCHOR_PCT = 0.40;
Â  Â  Â  Â 
Â  Â  Â  Â  let cameraAnchorX;
Â  Â  Â  Â  let trackOffset = 0;
Â  Â  Â  Â  let lastFrameTime = 0;
Â  Â  Â  Â  const POKEMON_IMAGE_SIZE = 88;
Â  Â  Â  Â  const NAME_TAG_FONT_SIZE = 20;
Â  Â  Â  Â  const NAME_TAG_PADDING = 8;
Â  Â  Â  Â  const GRASS_AREA_HEIGHT = 100;
Â  Â  Â  Â  let laneHeight = 100;
Â  Â  Â  Â  const START_LINE_X = 50;
Â  Â  Â  Â 
Â  Â  Â  Â  const BASE_SPEED_PER_SECOND = 80 * 1.25;
Â  Â  Â  Â  const BASE_MOMENTUM_FACTOR = 0.95;
Â  Â  Â  Â  const SURGE_MULTIPLIER = 1.6;
Â  Â  Â  Â  const DEBUFF_MULTIPLIER = 0.6;
Â  Â  Â  Â 
Â  Â  Â  Â  const RUBBER_BAND_FACTOR = 0.00;
Â  Â  Â  Â  const SHORT_BOOST_MULTIPLIER = 1.7;
Â  Â  Â  Â  const SHORT_DEBUFF_MULTIPLIER = 0.4;
Â  Â  Â  Â  const SHORT_BOOST_INTERVAL = 800;
Â  Â  Â  Â  const SHORT_DEBUFF_INTERVAL = 800;
Â  Â  Â  Â  const LEAD_SLOWDOWN_CHANCE = 0.3;
Â  Â  Â  Â 
Â  Â  Â  Â  const VOLATILITY_SWING = 0.3;
Â  Â  Â  Â 
Â  Â  Â  Â  const CAMERA_SMOOTHING_FACTOR = 0.1;
Â  Â  Â  Â  let lastBoostTime = 0;
Â  Â  Â  Â  let lastDebuffTime = 0;
Â  Â  Â  Â  let activeShortBooster = null;
Â  Â  Â  Â  let activeShortDebuffer = null;
Â  Â  Â  Â  let shortBoostEndTime = 0;
Â  Â  Â  Â  let shortDebuffEndTime = 0;
Â  Â  Â  Â  const STAMINA_COST_SURGE = 35;
Â  Â  Â  Â  const STAMINA_REGEN_RATE = 2.5;
Â  Â  Â  Â  // POSITIONAL ALGORITHM CONSTANTS
Â  Â  Â  Â  const LEADER_DEBUFF_DURATION = 2500;
Â  Â  Â  Â  const LEADER_DEBUFF_MULTIPLIER = 0.3;
Â  Â  Â  Â  const LEADER_DEBUFF_COOLDOWN = 2000;
Â  Â  Â  Â  const LAST_BOOST_DURATION = 3500;
Â  Â  Â  Â  const LAST_BOOST_MULTIPLIER = 2.2;
Â  Â  Â  Â  const LAST_BOOST_COOLDOWN = 1000;
Â  Â  Â  Â 
Â  Â  Â  Â  let TARGET_RACE_TIME_SECONDS = 60;
Â  Â  Â  Â  let racers = [];
Â  Â  Â  Â  let sceneryLayers = { back: [], mid: [], front: [] };
Â  Â  Â  Â  let isRacing = false;
Â  Â  Â  Â  let raceFinished = false;
Â  Â  Â  Â  let raceStartTime;
Â  Â  Â  Â  let animationFrameId;
Â  Â  Â  Â  let frameCount = 0;
Â  Â  Â  Â  let currentLeaderX = 0;
Â  Â  Â  Â 
Â  Â  Â  Â  let FIXED_FINISH_LINE_X = 0;
Â  Â  Â  Â  let DYNAMIC_FINISH_LINE_X = 0;
Â  Â  Â  Â  let RACE_LENGTH = 4500;
Â  Â  Â  Â  let IDEAL_SPEED_PER_SECOND = 0;
Â  Â  Â  Â  let finishPositions = [];
Â  Â  Â  Â  const RACE_STATES = { SETUP: 'SETUP', PREPARING: 'PREPARING', READY: 'READY' };
Â  Â  Â  Â  let raceState = RACE_STATES.SETUP;
Â  Â  Â  Â  const pokemonData = [];
Â  Â  Â  Â  for (let id = 1; id <= 151; id++) {
Â  Â  Â  Â  Â  Â  pokemonData.push({
Â  Â  Â  Â  Â  Â  Â  Â  id, name: `Poke ${id}`,
Â  Â  Â  Â  Â  Â  Â  Â  imageGif: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${id}.gif`,
Â  Â  Â  Â  Â  Â  Â  Â  imagePng: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`,
Â  Â  Â  Â  Â  Â  Â  Â  sprite: null
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  pokemonData.forEach(p => {
Â  Â  Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  Â  Â  img.onload = () => { p.sprite = img; };
Â  Â  Â  Â  Â  Â  img.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const img2 = new Image();
Â  Â  Â  Â  Â  Â  Â  Â  img2.onload = () => { p.sprite = img2; };
Â  Â  Â  Â  Â  Â  Â  Â  img2.src = p.imagePng;
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  img.src = p.imageGif;
Â  Â  Â  Â  });
Â  Â  Â  Â  const logoImage = new Image();
Â  Â  Â  Â  logoImage.src = 'https://60fb7b08eaf293096e8c.cdn6.editmysite.com/uploads/b/60fb7b08eaf293096e8cb3f63df9e65735b8a1ee75f6d23d21eaed2115dfa2e6/IMG_7388_1701827680.jpeg?width=2400&optimize=medium';
Â  Â  Â  Â 
Â  Â  Â  Â  function getRandomInt(min, max) {
Â  Â  Â  Â  Â  Â  min = Math.ceil(min);
Â  Â  Â  Â  Â  Â  max = Math.floor(max);
Â  Â  Â  Â  Â  Â  return Math.floor(Math.random() * (max - min + 1)) + min;
Â  Â  Â  Â  }
Â  Â  Â  Â 
Â  Â  Â  Â  function formatMMSS(secondsFloat) {
Â  Â  Â  Â  Â  Â  if (isNaN(secondsFloat) || secondsFloat === null || secondsFloat === Infinity) return "DNF";
Â  Â  Â  Â  Â  Â  const total = Math.max(0, secondsFloat);
Â  Â  Â  Â  Â  Â  const mins = Math.floor(total / 60);
Â  Â  Â  Â  Â  Â  const secs = total % 60;
Â  Â  Â  Â  Â  Â  return `${String(mins).padStart(2,'0')}:${String(Math.floor(secs)).padStart(2,'0')}`;
Â  Â  Â  Â  }
Â  Â  Â  Â 
Â  Â  Â  Â  function drawTimer() {
Â  Â  Â  Â  Â  Â  // Timer functionality removed
Â  Â  Â  Â  }
Â  Â  Â  Â  function drawSceneryLayer(layer, parallaxFactor) {
Â  Â  Â  Â  Â  Â  const layerOffset = trackOffset * parallaxFactor;
Â  Â  Â  Â  Â  Â  layer.forEach(obj => {
Â  Â  Â  Â  Â  Â  Â  Â  if (obj.x > layerOffset - 50 && obj.x < layerOffset + canvas.width + 50) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.translate(obj.x, obj.y);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (obj.type === 'tree') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.scale(obj.scale, obj.scale);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#6a3e1a'; ctx.fillRect(0, 0, 12, 24);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#005400'; ctx.beginPath(); ctx.arc(6, 0, 18, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (obj.type === 'house') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.scale(obj.scale, obj.scale);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#8B0000';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, 50, 40);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#555';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(-5, 0); ctx.lineTo(55, 0); ctx.lineTo(25, -25);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (obj.type === 'spectator') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.scale(obj.scale, obj.scale);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#008000';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.arc(0, 0, 10, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#FFDAB9';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.arc(0, -15, 5, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // MODIFIED drawRacer function for sharper text
Â  Â  Â  Â  function drawRacer(racer){
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.translate(racer.x, racer.y);
Â  Â  Â  Â  Â  Â  const strideBob = isRacing ? Math.sin(frameCount / 8 + racer.speedPhase) * 4 : 0;
Â  Â  Â  Â  Â  Â  ctx.translate(0, strideBob);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (racer.data.sprite && racer.data.sprite.complete) {
Â  Â  Â  Â  Â  Â  Â  Â  try { ctx.drawImage(racer.data.sprite, -POKEMON_IMAGE_SIZE/2, -POKEMON_IMAGE_SIZE/2, POKEMON_IMAGE_SIZE, POKEMON_IMAGE_SIZE); } catch(e){}
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // **IMPROVED TEXT RENDERING FOR SHARPNESS**
Â  Â  Â  Â  Â  Â  ctx.imageSmoothingEnabled = false; // Prevents the canvas from blurring the sprite/text on transformations
Â  Â  Â  Â  Â  Â  ctx.font = `bold ${NAME_TAG_FONT_SIZE}px "Bebas Neue", sans-serif`; // Ensure custom font is used correctly
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nameText = racer.name;
Â  Â  Â  Â  Â  Â  const textWidth = ctx.measureText(nameText).width;
Â  Â  Â  Â  Â  Â  const tagY = -POKEMON_IMAGE_SIZE/2 - (NAME_TAG_FONT_SIZE + NAME_TAG_PADDING)/2 - 5;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw name tag background
Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'rgba(0,0,0,0.7)';
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#aaaaaa';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 2;
Â  Â  Â  Â  Â  Â  ctx.fillRect(-textWidth/2 - NAME_TAG_PADDING, tagY - (NAME_TAG_FONT_SIZE + NAME_TAG_PADDING)/2, textWidth + NAME_TAG_PADDING*2, NAME_TAG_FONT_SIZE + NAME_TAG_PADDING);
Â  Â  Â  Â  Â  Â  ctx.strokeRect(-textWidth/2 - NAME_TAG_PADDING, tagY - (NAME_TAG_FONT_SIZE + NAME_TAG_PADDING)/2, textWidth + NAME_TAG_PADDING*2, NAME_TAG_FONT_SIZE + NAME_TAG_PADDING);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw name text
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#FFFFFF';Â 
Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';Â 
Â  Â  Â  Â  Â  Â  ctx.textBaseline = 'middle';Â 
Â  Â  Â  Â  Â  Â  ctx.fillText(nameText, 0, tagY);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }
Â  Â  Â  Â  // END MODIFIED drawRacer
Â  Â  Â  Â Â 
Â  Â  Â  Â  function drawStartLine(){ ctx.strokeStyle='white'; ctx.lineWidth=8; ctx.beginPath(); ctx.moveTo(START_LINE_X-10, GRASS_AREA_HEIGHT); ctx.lineTo(START_LINE_X-10, canvas.height-GRASS_AREA_HEIGHT); ctx.stroke(); }
Â  Â  Â  Â  function drawFinishLine(){
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  const finishX = DYNAMIC_FINISH_LINE_X;
Â  Â  Â  Â  Â  Â  const COLOR_PRIMARY = '#ffffff';
Â  Â  Â  Â  Â  Â  const COLOR_SECONDARY = '#000000';
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // Draw checkered pattern
Â  Â  Â  Â  Â  Â  const squareSize = 20;
Â  Â  Â  Â  Â  Â  const numSquares = Math.ceil((canvas.height - GRASS_AREA_HEIGHT * 2) / squareSize);
Â  Â  Â  Â  Â  Â  const lineWidth = 60;
Â  Â  Â  Â  Â  Â  const stripeWidth = lineWidth / 2;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  for (let y = 0; y < numSquares; y++) {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = (y) % 2 === 0 ? COLOR_PRIMARY : COLOR_SECONDARY;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finishX - lineWidth / 2,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  GRASS_AREA_HEIGHT + y * squareSize,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stripeWidth,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  squareSize
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = (y) % 2 === 0 ? COLOR_SECONDARY : COLOR_PRIMARY;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finishX - lineWidth / 2 + stripeWidth,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  GRASS_AREA_HEIGHT + y * squareSize,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stripeWidth,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  squareSize
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // Draw banner above track
Â  Â  Â  Â  Â  Â  const bannerWidth = 300;
Â  Â  Â  Â  Â  Â  const bannerHeight = 50;
Â  Â  Â  Â  Â  Â  const bannerY = GRASS_AREA_HEIGHT - bannerHeight - 10;
Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'rgba(0,0,0,0.9)';
Â  Â  Â  Â  Â  Â  ctx.fillRect(finishX - bannerWidth / 2, bannerY, bannerWidth, bannerHeight);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#00eaff';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 6;
Â  Â  Â  Â  Â  Â  ctx.strokeRect(finishX - bannerWidth / 2, bannerY, bannerWidth, bannerHeight);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // Draw "FINISH" text on banner
Â  Â  Â  Â  Â  Â  ctx.font = 'bold 42px Orbitron';
Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  ctx.textBaseline = 'middle';
Â  Â  Â  Â  Â  Â  ctx.shadowColor = '#00eaff';
Â  Â  Â  Â  Â  Â  ctx.shadowBlur = 15;
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#00eaff';
Â  Â  Â  Â  Â  Â  ctx.fillText('FINISH LINE', finishX, bannerY + bannerHeight / 2);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#000000';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 3;
Â  Â  Â  Â  Â  Â  ctx.strokeText('FINISH LINE', finishX, bannerY + bannerHeight / 2);
Â  Â  Â  Â  Â  Â  ctx.shadowBlur = 0;
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }
Â  Â  Â  Â  function drawBackgroundAndTrack(){
Â  Â  Â  Â  Â  Â  const currentTrackLength = RACE_LENGTH;
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#2b6f2b'; ctx.fillRect(0, 0, currentTrackLength, canvas.height);
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#5a5a5a'; ctx.fillRect(0, GRASS_AREA_HEIGHT, currentTrackLength, canvas.height - (GRASS_AREA_HEIGHT * 2));
Â  Â  Â  Â  }
Â  Â  Â  Â  function drawAll(){
Â  Â  Â  Â  Â  Â  ctx.clearRect(0,0,canvas.width,canvas.height);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.translate(-trackOffset, 0);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  drawBackgroundAndTrack();
Â  Â  Â  Â  Â  Â  drawSceneryLayer(sceneryLayers.back, 0.3);
Â  Â  Â  Â  Â  Â  drawSceneryLayer(sceneryLayers.mid, 0.6);
Â  Â  Â  Â  Â  Â  drawStartLine();
Â  Â  Â  Â  Â  Â  racers.forEach(drawRacer);
Â  Â  Â  Â  Â  Â  drawFinishLine();
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  drawTimer();
Â  Â  Â  Â  }
Â  Â  Â  Â  function initRacers() {
Â  Â  Â  Â  Â  Â  racers = [];
Â  Â  Â  Â  Â  Â  const customNamesInput = document.getElementById('racerNames');
Â  Â  Â  Â  Â  Â  let customNames = customNamesInput.value.split('\n').map(name => name.trim()).filter(name => name);
Â  Â  Â  Â  Â  Â  if (customNames.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  customNames = customNamesInput.placeholder.split('\n').map(name => name.trim()).filter(name => name);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const shuffledPokemon = [...pokemonData].sort(() => 0.5 - Math.random());
Â  Â  Â  Â  Â  Â  const numRacers = Math.min(customNames.length, shuffledPokemon.length);
Â  Â  Â  Â  Â  Â  for (let i = 0; i < numRacers; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  racers.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: customNames[i],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: shuffledPokemon[i],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: START_LINE_X,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: GRASS_AREA_HEIGHT + i * laneHeight + laneHeight / 2,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  baseSpeed: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSpeed: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speedPhase: Math.random() * Math.PI * 2,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  surgeActive: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDebuffed: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastSurgeTime: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stamina: 100,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headTurn: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDrafting: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLeadingSince: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLastSince: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLeaderDebuffed: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debuffEndTime: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLastBoosted: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  boostEndTime: 0
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function reassignPokemons() {
Â  Â  Â  Â  Â  Â  if (racers.length === 0) return;
Â  Â  Â  Â  Â  Â  const shuffledPokemon = [...pokemonData].sort(() => 0.5 - Math.random());
Â  Â  Â  Â  Â  Â  racers.forEach((racer, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  racer.data = shuffledPokemon[i];
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  drawAll();
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateCanvasSettings() {
Â  Â  Â  Â  Â  Â  const isFullscreen = raceView.classList.contains('fullscreen');
Â  Â  Â  Â  Â  Â  CANVAS_VIEWPORT_WIDTH = isFullscreen ? Math.min(window.innerWidth * 0.85, 1400) : Math.max(setupControls.clientWidth, 300);
Â  Â  Â  Â  Â  Â  CANVAS_VIEWPORT_HEIGHT = isFullscreen ? Math.min(window.innerHeight * 0.85, 800) : Math.max(480, document.documentElement.clientHeight * 0.6);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // Race time is now approximate, only used to calculate fixed distance
Â  Â  Â  Â  Â  Â  const targetTime = Math.max(10, Math.min(300, parseInt(document.getElementById('raceTimeSeconds').value) || 60));
Â  Â  Â  Â  Â  Â  TARGET_RACE_TIME_SECONDS = targetTime;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const tempFinishX = BASE_SPEED_PER_SECOND * TARGET_RACE_TIME_SECONDS;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // FIXED finish line based on target time
Â  Â  Â  Â  Â  Â  FIXED_FINISH_LINE_X = Math.max(2000, Math.round(tempFinishX * 1.5));
Â  Â  Â  Â  Â  Â  DYNAMIC_FINISH_LINE_X = FIXED_FINISH_LINE_X;
Â  Â  Â  Â  Â  Â  RACE_LENGTH = DYNAMIC_FINISH_LINE_X + 1500;
Â  Â  Â  Â  Â  Â  document.getElementById('raceLengthDisplay').value = DYNAMIC_FINISH_LINE_X.toFixed(0);
Â  Â  Â  Â  Â  Â  canvas.width = CANVAS_VIEWPORT_WIDTH;
Â  Â  Â  Â  Â  Â  canvas.height = CANVAS_VIEWPORT_HEIGHT;
Â  Â  Â  Â  Â  Â  laneHeight = (canvas.height - (GRASS_AREA_HEIGHT * 2)) / Math.max(1, racers.length);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  IDEAL_SPEED_PER_SECOND = (FIXED_FINISH_LINE_X - START_LINE_X) / TARGET_RACE_TIME_SECONDS;
Â  Â  Â  Â  Â  Â  // MODIFIED: Anchor at 40%
Â  Â  Â  Â  Â  Â  cameraAnchorX = CANVAS_VIEWPORT_WIDTH * FIXED_RACER_X_ANCHOR_PCT;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  if (racers.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  racers.forEach((racer, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.y = GRASS_AREA_HEIGHT + index * laneHeight + laneHeight / 2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Extreme randomization range (0.85 to 1.15)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.baseSpeed = IDEAL_SPEED_PER_SECOND * (1.0 - 0.15 + Math.random() * 0.3);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â 
Â  Â  Â  Â  function initScenery() {
Â  Â  Â  Â  Â  Â  sceneryLayers = { back: [], mid: [], front: [] };
Â  Â  Â  Â  Â  Â  const sceneryTypes = ['tree', 'house', 'spectator'];
Â  Â  Â  Â  Â  Â  const numObjects = 60;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < numObjects; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const type = sceneryTypes[Math.floor(Math.random() * sceneryTypes.length)];
Â  Â  Â  Â  Â  Â  Â  Â  const top = Math.random() > 0.5;
Â  Â  Â  Â  Â  Â  Â  Â  const y = top ? Math.random() * (GRASS_AREA_HEIGHT - 30) + 10 : canvas.height - GRASS_AREA_HEIGHT + Math.random() * (GRASS_AREA_HEIGHT - 30) + 10;
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.random() < 0.3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sceneryLayers.back.push({ type, x: Math.random() * RACE_LENGTH * 1.2, y, scale: 0.7 });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sceneryLayers.mid.push({ type, x: Math.random() * RACE_LENGTH, y, scale: 1.0 });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateRacers(deltaTimeSeconds){
Â  Â  Â  Â  Â  Â  if (!raceStartTime) return;
Â  Â  Â  Â  Â  Â  const now = performance.now();
Â  Â  Â  Â  Â  Â  const elapsedMilliseconds = now - raceStartTime;
Â  Â  Â  Â  Â  Â  let elapsedSeconds = elapsedMilliseconds / 1000;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const sortedRacers = [...racers].sort((a, b) => b.x - a.x);
Â  Â  Â  Â  Â  Â  let leader = sortedRacers[0];
Â  Â  Â  Â  Â  Â  let lastRacer = sortedRacers[sortedRacers.length - 1];
Â  Â  Â  Â  Â  Â  if (!leader || !lastRacer) return;
Â  Â  Â  Â  Â  Â  const currentTime = performance.now();
Â  Â  Â  Â  Â  Â  racers.forEach(racer => {
Â  Â  Â  Â  Â  Â  Â  Â  // Decay the positional effects if their time is up
Â  Â  Â  Â  Â  Â  Â  Â  if (racer.debuffEndTime > 0 && currentTime > racer.debuffEndTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLeaderDebuffed = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.debuffEndTime = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (racer.boostEndTime > 0 && currentTime > racer.boostEndTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLastBoosted = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.boostEndTime = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // --- Leader Debuff Logic ---
Â  Â  Â  Â  Â  Â  Â  Â  if (racer === leader) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!racer.isLeaderDebuffed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (racer.isLeadingSince === 0) racer.isLeadingSince = currentTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentTime - racer.isLeadingSince > LEADER_DEBUFF_COOLDOWN) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLeaderDebuffed = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.debuffEndTime = currentTime + LEADER_DEBUFF_DURATION;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLeadingSince = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLastSince = 0;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (racer.isLeadingSince !== 0 && !racer.isLeaderDebuffed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLeadingSince = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // --- Last Place Boost Logic ---
Â  Â  Â  Â  Â  Â  Â  Â  if (racer === lastRacer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!racer.isLastBoosted) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (racer.isLastSince === 0) racer.isLastSince = currentTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentTime - racer.isLastSince > LAST_BOOST_COOLDOWN) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLastBoosted = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.boostEndTime = currentTime + LAST_BOOST_DURATION;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLastSince = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLeadingSince = 0;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (racer.isLastSince !== 0 && !racer.isLastBoosted) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  racer.isLastSince = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // 3. Update Racer Speeds with Modifiers
Â  Â  Â  Â  Â  Â  const packCenterX = racers.reduce((sum, r) => sum + r.x, 0) / racers.length;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  racers.forEach(racer => {
Â  Â  Â  Â  Â  Â  Â  Â  if (racer.stamina < 100) racer.stamina = Math.min(100, racer.stamina + STAMINA_REGEN_RATE * deltaTimeSeconds);
Â  Â  Â  Â  Â  Â  Â  Â  const staminaModifier = 0.7 + 0.3 * (racer.stamina / 100);
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  const distanceFromCenter = racer.x - packCenterX;
Â  Â  Â  Â  Â  Â  Â  Â  // RUBBER BANDING IS REMOVED
Â  Â  Â  Â  Â  Â  Â  Â  const rubberBandAdjustment = -distanceFromCenter * 0.00;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  const volatility = 1.0 + (Math.random() * VOLATILITY_SWING * 2 - VOLATILITY_SWING);
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  let naturalSpeed = racer.baseSpeed * BASE_MOMENTUM_FACTOR * staminaModifier + rubberBandAdjustment;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  naturalSpeed *= volatility;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (racer.surgeActive) naturalSpeed *= SURGE_MULTIPLIER;
Â  Â  Â  Â  Â  Â  Â  Â  if (racer.isDebuffed) naturalSpeed *= DEBUFF_MULTIPLIER;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (racer === activeShortBooster) naturalSpeed *= SHORT_BOOST_MULTIPLIER;
Â  Â  Â  Â  Â  Â  Â  Â  if (racer === activeShortDebuffer) naturalSpeed *= SHORT_DEBUFF_MULTIPLIER;
Â  Â  Â  Â  Â  Â  Â  Â  if (racer.isLeaderDebuffed) naturalSpeed *= LEADER_DEBUFF_MULTIPLIER;
Â  Â  Â  Â  Â  Â  Â  Â  if (racer.isLastBoosted) naturalSpeed *= LAST_BOOST_MULTIPLIER;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  // NO SYNCHRONIZATION LOGIC APPLIED
Â  Â  Â  Â  Â  Â  Â  Â  racer.currentSpeed = Math.max(1, naturalSpeed);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // 4. Race ends when the FIRST racer crosses the line.
Â  Â  Â  Â  Â  Â  let firstFinisher = null;
Â  Â  Â  Â  Â  Â  let timeToFinish = Infinity;
Â  Â  Â  Â  Â  Â  for (const racer of racers) {
Â  Â  Â  Â  Â  Â  Â  Â  racer.nextX = racer.x + racer.currentSpeed * deltaTimeSeconds;
Â  Â  Â  Â  Â  Â  Â  Â  if (racer.nextX >= DYNAMIC_FINISH_LINE_X && racer.x < DYNAMIC_FINISH_LINE_X) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const distToFinish = DYNAMIC_FINISH_LINE_X - racer.x;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ttF = distToFinish / racer.currentSpeed;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ttF < timeToFinish) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeToFinish = ttF;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  firstFinisher = racer;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (firstFinisher) {
Â  Â  Â  Â  Â  Â  Â  Â  isRacing = false;
Â  Â  Â  Â  Â  Â  Â  Â  raceFinished = true;
Â  Â  Â  Â  Â  Â  Â  Â  cancelAnimationFrame(animationFrameId);
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Calculate precise finish time
Â  Â  Â  Â  Â  Â  Â  Â  const finalRaceTime = elapsedSeconds + timeToFinish;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  firstFinisher.x = DYNAMIC_FINISH_LINE_X;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  captureFinishPositions(finalRaceTime);
Â  Â  Â  Â  Â  Â  Â  Â  showWinnerAnimation(firstFinisher.name);
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawAll();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  winnerOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  raceView.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayFinalLeaderboard();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  leaderboard.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  leaderboard.classList.add('fullscreen');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  postRaceControls.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 3000);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // 5. Final Position Update
Â  Â  Â  Â  Â  Â  racers.forEach(racer => {
Â  Â  Â  Â  Â  Â  Â  Â  racer.x += racer.currentSpeed * deltaTimeSeconds;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateCamera(){
Â  Â  Â  Â  Â  Â  if (!isRacing && !raceFinished) { trackOffset = 0; return; };
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const currentLeaderX = racers.reduce((max, r) => Math.max(max, r.x), 0);
Â  Â  Â  Â  Â  Â  const minX = racers.reduce((min, r) => Math.min(min, r.x), currentLeaderX);
Â  Â  Â  Â  Â  Â  let desiredOffset = currentLeaderX - cameraAnchorX;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const minAllowedOffset = Math.max(0, minX - CANVAS_VIEWPORT_WIDTH * 0.1);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  desiredOffset = Math.max(minAllowedOffset, desiredOffset);
Â  Â  Â  Â  Â  Â  const maxOffset = Math.max(0, RACE_LENGTH - CANVAS_VIEWPORT_WIDTH);
Â  Â  Â  Â  Â  Â  desiredOffset = Math.min(desiredOffset, maxOffset);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  trackOffset += (desiredOffset - trackOffset) * CAMERA_SMOOTHING_FACTOR;
Â  Â  Â  Â  }
Â  Â  Â  Â  function animate(currentTime){
Â  Â  Â  Â  Â  Â  if (!lastFrameTime) lastFrameTime = currentTime;
Â  Â  Â  Â  Â  Â  const deltaTimeSeconds = (currentTime - lastFrameTime) / 1000;
Â  Â  Â  Â  Â  Â  lastFrameTime = currentTime;
Â  Â  Â  Â  Â  Â  frameCount++;
Â  Â  Â  Â  Â  Â  if (isRacing) {
Â  Â  Â  Â  Â  Â  Â  Â  updateRacers(deltaTimeSeconds);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateCamera();
Â  Â  Â  Â  Â  Â  drawAll();
Â  Â  Â  Â  Â  Â  if (!raceFinished) {
Â  Â  Â  Â  Â  Â  Â  Â  animationFrameId = requestAnimationFrame(animate);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function captureFinishPositions(winnerTime){
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  finishPositions = racers.map(r => {
Â  Â  Â  Â  Â  Â  Â  Â  let resultTime;
Â  Â  Â  Â  Â  Â  Â  Â  if (r.x >= DYNAMIC_FINISH_LINE_X) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultTime = winnerTime;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (r.currentSpeed > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const distanceRemaining = DYNAMIC_FINISH_LINE_X - r.x;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const timeRemaining = distanceRemaining / r.currentSpeed;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultTime = winnerTime + timeRemaining;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultTime = Infinity;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  return { name: r.name, finalX: r.x, currentSpeed: r.currentSpeed, resultTime };
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  finishPositions.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (a.resultTime === Infinity) return 1;
Â  Â  Â  Â  Â  Â  Â  Â  if (b.resultTime === Infinity) return -1;
Â  Â  Â  Â  Â  Â  Â  Â  return a.resultTime - b.resultTime;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  function displayFinalLeaderboard(){
Â  Â  Â  Â  Â  Â  document.getElementById('leaderboardTitle').textContent = 'ğŸ FINAL RACE RESULTS ğŸ†';
Â  Â  Â  Â  Â  Â  const listContainer = document.getElementById('leaderboardList');
Â  Â  Â  Â  Â  Â  listContainer.innerHTML = finishPositions.map((r, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  const rank = i + 1;
Â  Â  Â  Â  Â  Â  Â  Â  const isWinner = rank === 1;
Â  Â  Â  Â  Â  Â  Â  Â  const rankDisplay = isWinner ? `<span class="trophy">ğŸ†</span> 1.` : `${rank}.`;
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="leaderboard-entry ${isWinner ? 'winner-entry' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="rank-number">${rankDisplay}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong class="racer-name-leaderboard">${r.name}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="time-result">${formatMMSS(r.resultTime)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â  function submitNames(){
Â  Â  Â  Â  Â  Â  const customNames = document.getElementById('racerNames').value.split('\n').map(name => name.trim()).filter(Boolean);
Â  Â  Â  Â  Â  Â  const submittedNamesDiv = document.getElementById('submittedNames');
Â  Â  Â  Â  Â  Â  const submittedNamesList = document.getElementById('submittedNamesList');
Â  Â  Â  Â  Â  Â  if (customNames.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  submittedNamesDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  submittedNamesList.innerHTML = customNames.map((name,i)=>`<li>${i+1}. ${name}</li>`).join('');
Â  Â  Â  Â  Â  Â  submittedNamesDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  statusDisplay.textContent = `Submitted ${customNames.length} racer${customNames.length===1?'':'s'}. Ready!`;
Â  Â  Â  Â  Â  Â  initRacers();
Â  Â  Â  Â  Â  Â  updateCanvasSettings();
Â  Â  Â  Â  Â  Â  drawAll();
Â  Â  Â  Â  }
Â  Â  Â  Â  function handleStartButton(){
Â  Â  Â  Â  Â  Â  if (racers.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  submitNames();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  if (racers.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  statusDisplay.textContent = 'Please enter at least one racer name before starting.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  if (raceState === RACE_STATES.SETUP) prepareRace();
Â  Â  Â  Â  Â  Â  else if (raceState === RACE_STATES.PREPARING) startRace();
Â  Â  Â  Â  }
Â  Â  Â  Â  function prepareRace(){
Â  Â  Â  Â  Â  Â  raceState = RACE_STATES.PREPARING;
Â  Â  Â  Â  Â  Â  setupControls.style.display = 'none'; document.getElementById('submittedNames').style.display = 'none';
Â  Â  Â  Â  Â  Â  raceView.style.display = 'flex'; raceControls.style.display = 'flex';
Â  Â  Â  Â  Â  Â  raceView.classList.add('fullscreen');
Â  Â  Â  Â  Â  Â  initRacers(); updateCanvasSettings(); initScenery(); drawAll();
Â  Â  Â  Â  Â  Â  statusDisplay.textContent = 'PREPARE: Click START RACE (GO!).';
Â  Â  Â  Â  }
Â  Â  Â  Â  function startRace(){
Â  Â  Â  Â  Â  Â  raceState = RACE_STATES.READY; isRacing = true; raceFinished = false;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  lastBoostTime = performance.now();
Â  Â  Â  Â  Â  Â  activeShortBooster = null;
Â  Â  Â  Â  Â  Â  lastDebuffTime = performance.now();
Â  Â  Â  Â  Â  Â  activeShortDebuffer = null;
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  racers.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  r.isLeadingSince = 0;
Â  Â  Â  Â  Â  Â  Â  Â  r.isLastSince = 0;
Â  Â  Â  Â  Â  Â  Â  Â  r.isLeaderDebuffed = false;
Â  Â  Â  Â  Â  Â  Â  Â  r.debuffEndTime = 0;
Â  Â  Â  Â  Â  Â  Â  Â  r.isLastBoosted = false;
Â  Â  Â  Â  Â  Â  Â  Â  r.boostEndTime = 0;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  raceStartTime = performance.now();
Â  Â  Â  Â  Â  Â  lastFrameTime = performance.now();
Â  Â  Â  Â  Â  Â  statusDisplay.textContent = 'GO! RACE HAS BEGUN!';
Â  Â  Â  Â  Â  Â  raceControls.style.display = 'none';
Â  Â  Â  Â  Â  Â  cancelAnimationFrame(animationFrameId); animationFrameId = requestAnimationFrame(animate);
Â  Â  Â  Â  }
Â  Â  Â  Â  function resetRace(){
Â  Â  Â  Â  Â  Â  raceState = RACE_STATES.SETUP; isRacing = false; raceFinished = false;
Â  Â  Â  Â  Â  Â  cancelAnimationFrame(animationFrameId);
Â  Â  Â  Â  Â  Â  winnerOverlay.style.display = 'none'; leaderboard.style.display = 'none';
Â  Â  Â  Â  Â  Â  leaderboard.classList.remove('fullscreen');
Â  Â  Â  Â  Â  Â  setupControls.style.display = 'block'; raceView.style.display = 'none';
Â  Â  Â  Â  Â  Â  raceView.classList.remove('fullscreen');
Â  Â  Â  Â  Â  Â  postRaceControls.style.display = 'none';
Â  Â  Â  Â  Â  Â  statusDisplay.textContent = 'Systems nominal. Enter names to begin.';
Â  Â  Â  Â  Â  Â  initRacers();
Â  Â  Â  Â  Â  Â  updateCanvasSettings();
Â  Â  Â  Â  Â  Â  drawAll();
Â  Â  Â  Â  }
Â  Â  Â  Â  function showWinnerAnimation(winnerName){
Â  Â  Â  Â  Â  Â  document.getElementById('winnerName').textContent = winnerName + " WINS!";
Â  Â  Â  Â  Â  Â  winnerOverlay.style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  Â  Â  submitNamesButton.addEventListener('click', submitNames);
Â  Â  Â  Â  setupStartButton.addEventListener('click', handleStartButton);
Â  Â  Â  Â  raceScreenStartButton.addEventListener('click', handleStartButton);
Â  Â  Â  Â  shuffleButton.addEventListener('click', reassignPokemons);
Â  Â  Â  Â  window.addEventListener('resize', () => {
Â  Â  Â  Â  Â  Â  if (raceState !== RACE_STATES.SETUP) {
Â  Â  Â  Â  Â  Â  Â  Â  updateCanvasSettings(); initScenery(); drawAll();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  initRacers();
Â  Â  Â  Â  updateCanvasSettings();
Â  Â  Â  Â  drawAll();
Â  Â  </script>
</body>
</html>
