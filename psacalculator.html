<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gladiator | Pro Dashboard</title>
    <link rel="icon" type="image/webp" href="https://raw.githubusercontent.com/Kronborg1980/Gladiator-Collectables/main/logogla.webp">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-dark: #050505; --gold: #D4AF37; --text-main: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); background-image: radial-gradient(circle at 50% 0%, #1a1500 0%, #000 60%); color: var(--text-main); height: 100vh; overflow: hidden; }
        .font-brand { font-family: 'Cinzel', serif; }
        .text-gold-gradient { background: linear-gradient(to right, #D4AF37, #FFE5B4, #D4AF37); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .glass-panel { background: rgba(16, 16, 16, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .pro-input { background: transparent; border-bottom: 1px solid transparent; color: #aaa; transition: all 0.2s; padding: 2px 0; width: 100%; }
        .pro-input:hover { border-bottom-color: #333; color: white; }
        .pro-input:focus { border-bottom-color: var(--gold); outline: none; color: white; }
        .pro-input.number { font-family: 'Courier New', monospace; font-weight: 600; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }
        [v-cloak] { display: none; }
        select option { background-color: #000; color: #fff; padding: 8px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

<div id="app" v-cloak class="flex flex-col h-full w-full max-w-[1900px] mx-auto">
    
    <div class="hidden md:flex flex-col lg:flex-row justify-between items-end gap-6 p-6 pb-4 shrink-0">
        <div class="flex items-center gap-6">
            <div class="w-20 h-20 bg-black rounded-xl border border-[#222] flex items-center justify-center shadow-[0_0_25px_rgba(212,175,55,0.1)] p-3 relative group">
                <div class="absolute inset-0 bg-[#D4AF37] opacity-0 group-hover:opacity-5 rounded-xl transition"></div>
                <img src="https://raw.githubusercontent.com/Kronborg1980/Gladiator-Collectables/main/logogla.webp" class="w-full h-full object-contain">
            </div>
            <div>
                <h1 class="text-4xl font-bold font-brand text-white tracking-wide uppercase drop-shadow-lg">
                    Gladiator <span class="text-gold-gradient">Collectibles</span>
                </h1>
                <div class="flex gap-6 mt-2">
                    <div class="text-xs uppercase tracking-[0.15em] text-slate-500 font-bold">
                        Assets: <span class="text-white">{{ cards.length }}</span>
                    </div>
                    <div class="text-xs uppercase tracking-[0.15em] text-slate-500 font-bold">
                        Profit: <span :class="totalProfit >= 0 ? 'text-[#D4AF37]' : 'text-red-500'">${{ formatNumber(totalProfit) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 bg-[#111] p-2 rounded-xl border border-[#222] shadow-xl">
            <div class="relative group">
                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 group-focus-within:text-[#D4AF37] transition"></i>
                <input v-model="filter" placeholder="FILTER INV..." class="bg-black border border-[#222] text-white text-xs font-bold rounded-lg pl-10 pr-4 py-3 w-32 focus:w-48 focus:border-[#D4AF37] outline-none transition-all uppercase placeholder-slate-700 tracking-wider">
            </div>
            <div class="w-[1px] h-8 bg-[#222] mx-1"></div>
            <button @click="updatePrices" :disabled="isUpdating" class="w-10 h-10 flex items-center justify-center bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-green-400 rounded-lg transition border border-transparent hover:border-[#333]" title="Update Prices"><i class="fa-solid fa-arrows-rotate" :class="{'animate-spin': isUpdating}"></i></button>
            <button @click="exportExcel" class="w-10 h-10 flex items-center justify-center bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-green-500 rounded-lg transition border border-transparent hover:border-[#333]" title="Excel"><i class="fa-solid fa-file-excel"></i></button>
            <button @click="backup" class="w-10 h-10 flex items-center justify-center bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-blue-500 rounded-lg transition border border-transparent hover:border-[#333]" title="Save"><i class="fa-solid fa-download"></i></button>
            <label class="w-10 h-10 flex items-center justify-center bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-purple-500 rounded-lg transition border border-transparent hover:border-[#333] cursor-pointer" title="Load"><i class="fa-solid fa-upload"></i> <input type="file" @change="restore" class="hidden"></label>
            <div class="w-[1px] h-8 bg-[#222] mx-1"></div>
            <button @click="openSearch" class="flex items-center gap-2 px-6 py-3 bg-[#D4AF37] hover:bg-[#fff] text-black text-xs font-bold uppercase rounded-lg shadow-lg transition transform active:scale-95 tracking-wider"><i class="fa-solid fa-plus"></i> Add</button>
        </div>
    </div>
    
    <div class="md:hidden flex justify-between items-center p-4 bg-[#080808] border-b border-[#222] shrink-0 z-20">
        <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/Kronborg1980/Gladiator-Collectables/main/logogla.webp" class="w-10 h-10 object-contain">
            <h1 class="font-brand font-bold text-lg text-white">Gladiator</h1>
        </div>
        <div class="text-right">
             <div class="text-[10px] uppercase text-slate-500 font-bold tracking-widest">Net Profit</div>
             <div class="font-mono font-bold text-[#D4AF37]">${{ formatNumber(totalProfit) }}</div>
        </div>
    </div>

    <div class="flex-1 overflow-hidden relative md:px-6 md:pb-6">
        
        <div class="md:hidden h-full overflow-y-auto p-4 space-y-4 pb-24">
            <div class="flex gap-2 mb-4">
                <input v-model="filter" placeholder="Search..." class="flex-1 bg-[#111] border border-[#222] p-3 rounded text-sm text-white outline-none">
                <button @click="openSearch" class="bg-[#D4AF37] text-black px-4 rounded font-bold"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div v-for="(c, i) in filteredCards" :key="i" class="bg-[#111] border border-[#222] rounded-xl p-4 shadow-lg relative overflow-hidden">
                <div class="flex gap-4 items-start">
                    <div class="w-16 h-24 bg-black rounded border border-[#333] shrink-0">
                        <img v-if="c.img" :src="c.img" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-slate-200 text-sm truncate">{{ c.name }}</div>
                        <div class="text-[10px] text-slate-500 uppercase tracking-widest mb-2">{{ c.set }}</div>
                        <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded text-[10px] font-bold uppercase tracking-wider border" :class="getProfit(c) >= 0 ? 'bg-green-900/20 text-green-400 border-green-500/30' : 'bg-red-900/20 text-red-400 border-red-500/30'">Profit: ${{ Math.round(getProfit(c)) }}</div>
                    </div>
                    <button @click="remove(i)" class="text-slate-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-xs">
                    <div><label class="text-[9px] text-slate-600 uppercase">Condition</label><input v-model="c.condition" class="pro-input w-full text-slate-300"></div>
                    <div><label class="text-[9px] text-[#D4AF37] uppercase">Target Grade</label><select v-model="c.target" class="w-full bg-transparent text-[#D4AF37] font-bold outline-none"><option value="10">PSA 10</option><option value="9">PSA 9</option><option value="8">PSA 8</option></select></div>
                    <div><label class="text-[9px] text-slate-600 uppercase">Raw Cost</label><div class="flex text-slate-400">$<input v-model.number="c.raw" type="number" class="pro-input"></div></div>
                    <div><label class="text-[9px] text-slate-600 uppercase">Est. Value</label><div class="flex text-white font-bold">$<input :value="getValue(c)" @input="updateValue(c, $event.target.value)" type="number" class="pro-input"></div></div>
                </div>
            </div>
            <div v-if="cards.length === 0" class="text-center py-10 text-slate-600"><p>No Assets Found</p></div>
        </div>

        <div class="hidden md:flex flex-col h-full glass-panel rounded-2xl shadow-2xl">
            <div class="overflow-auto flex-1">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 z-10 bg-[#080808] shadow-md">
                        <tr class="text-[10px] text-slate-500 uppercase tracking-[0.1em] border-b border-[#222] h-10">
                            <th class="pl-4 w-12 text-center">Img</th>
                            <th class="px-2">Asset Details</th>
                            <th class="px-2 w-32">Condition</th>
                            <th class="px-2 text-right w-24">Raw $</th>
                            <th class="px-2 text-right w-24">Cost $</th>
                            <th class="px-2 text-center w-28 text-[#D4AF37]">Target</th>
                            <th class="px-2 text-right w-28 text-white">Est. Value</th>
                            <th class="px-2 text-right w-28">Net Profit</th>
                            <th class="px-2 text-center w-24">Action</th>
                            <th class="px-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody class="text-xs divide-y divide-[#1a1a1a]">
                        <tr v-for="(c, i) in filteredCards" :key="i" class="hover:bg-[#111] group transition-colors">
                            <td class="p-2 text-center">
                                <div class="w-8 h-11 mx-auto rounded border border-[#333] bg-black overflow-hidden relative group-hover:border-[#D4AF37] transition"><img v-if="c.img" :src="c.img" class="absolute inset-0 w-full h-full object-cover"></div>
                            </td>
                            <td class="p-2">
                                <div class="font-bold text-slate-200 truncate w-48" :title="c.name">{{ c.name }}</div>
                                <div class="text-[9px] font-semibold text-slate-500 uppercase tracking-wide">{{ c.set }}</div>
                            </td>
                            <td class="p-2"><input v-model="c.condition" type="text" placeholder="Notes..." class="pro-input w-full"></td>
                            <td class="p-2"><input v-model.number="c.raw" type="number" class="pro-input number w-full text-right text-slate-400"></td>
                            <td class="p-2"><input v-model.number="c.fee" type="number" class="pro-input number w-full text-right text-slate-500"></td>
                            <td class="p-2 text-center">
                                <select v-model="c.target" class="bg-transparent border-none text-[#D4AF37] font-bold text-[10px] cursor-pointer outline-none text-center hover:bg-[#1a1a1a] rounded">
                                    <option value="10">PSA 10</option><option value="9">PSA 9</option><option value="8">PSA 8</option>
                                </select>
                            </td>
                            <td class="p-2"><input :value="getValue(c)" @input="updateValue(c, $event.target.value)" type="number" class="pro-input number w-full text-right text-white font-bold bg-[#111] rounded px-1"></td>
                            <td class="p-2 text-right font-mono font-bold"><span :class="getProfit(c) >= 0 ? 'text-[#D4AF37]' : 'text-red-500'">{{ getProfit(c) >= 0 ? '+' : '' }}{{ Math.round(getProfit(c)) }}</span></td>
                            <td class="p-2 text-center">
                                <span v-if="getProfit(c) > 0" class="inline-flex items-center gap-1 bg-green-900/10 text-green-400 border border-green-500/20 px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider">GRADE</span>
                                <span v-else class="inline-flex items-center gap-1 bg-red-900/10 text-red-400 border border-red-500/20 px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider">HOLD</span>
                            </td>
                            <td class="p-2 text-center"><button @click="remove(i)" class="text-slate-600 hover:text-red-500 transition opacity-0 group-hover:opacity-100"><i class="fa-solid fa-times"></i></button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
             <div v-if="cards.length === 0" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="text-center">
                    <div class="bg-[#111] p-4 rounded-full inline-block mb-3 border border-[#222]"><i class="fa-solid fa-layer-group text-2xl text-[#333]"></i></div>
                    <h3 class="text-slate-500 font-bold font-brand tracking-widest uppercase text-sm">Inventory Empty</h3>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showSearch" class="fixed inset-0 bg-black/90 backdrop-blur-md flex items-start justify-center pt-10 z-50 p-4 transition-all">
        <div class="w-full max-w-5xl bg-[#0a0a0a] border border-[#222] rounded-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden animate-in fade-in zoom-in-95 duration-200">
            <div class="p-4 border-b border-[#222] bg-[#0f0f0f]">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold font-brand text-[#D4AF37] uppercase tracking-wide">Add Asset</h2>
                    <button @click="showSearch=false" class="text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                    
                    <div class="md:col-span-3 relative">
                        <label class="text-[9px] text-[#D4AF37] font-bold ml-1 mb-1 block tracking-wider">STEP 1: ERA</label>
                        <select v-model="selectedEra" class="w-full bg-[#050505] border border-[#333] text-white text-[10px] font-bold rounded px-3 py-3 outline-none uppercase appearance-none cursor-pointer hover:border-[#D4AF37] focus:border-[#D4AF37] transition shadow-lg">
                            <option value="">-- SELECT ERA --</option>
                            <option v-for="era in eras" :value="era">{{ era }}</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 bottom-3.5 text-slate-600 text-[10px] pointer-events-none"></i>
                    </div>

                    <div class="md:col-span-4 relative">
                        <label class="text-[9px] text-[#D4AF37] font-bold ml-1 mb-1 block tracking-wider">STEP 2: EXPANSION</label>
                        <select v-model="selectedSet" :disabled="!selectedEra" class="w-full bg-[#050505] border border-[#333] text-white text-[10px] font-bold rounded px-3 py-3 outline-none uppercase appearance-none cursor-pointer hover:border-[#D4AF37] focus:border-[#D4AF37] transition shadow-lg disabled:opacity-30 disabled:cursor-not-allowed">
                            <option value="">-- SELECT SET --</option>
                            <option v-for="set in filteredSets" :value="set.id">{{ set.name }} ({{ set.releaseDate.substring(0,4) }})</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 bottom-3.5 text-slate-600 text-[10px] pointer-events-none"></i>
                    </div>

                    <div class="md:col-span-5 relative">
                        <label class="text-[9px] text-[#D4AF37] font-bold ml-1 mb-1 block tracking-wider">STEP 3: POKEMON</label>
                        <i class="fa-solid fa-search absolute left-3 bottom-3 text-slate-500 text-xs"></i>
                        <input ref="searchBox" v-model="query" :disabled="!selectedSet" :placeholder="selectedSet ? 'Type Name (e.g. Charizard)...' : 'Waiting for Step 2...'" class="w-full bg-[#050505] border border-[#333] text-white rounded pl-9 pr-2 py-2.5 text-sm outline-none focus:border-[#D4AF37] uppercase disabled:opacity-30 disabled:cursor-not-allowed transition font-bold placeholder-slate-700">
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 bg-[#050505] relative">
                
                <div v-if="loading" class="flex flex-col items-center justify-center py-20 gap-3">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl text-[#D4AF37]"></i>
                    <div class="text-xs uppercase tracking-widest text-[#D4AF37] font-bold">Loading Set Data...</div>
                </div>
                
                <div v-else-if="filteredResults.length" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    <div v-for="item in filteredResults" :key="item.id" @click="add(item)" class="bg-[#111] border border-[#222] p-2 rounded-lg hover:border-[#D4AF37] cursor-pointer group hover:bg-[#161616] transition relative overflow-hidden">
                        <div class="aspect-[0.7] bg-black rounded overflow-hidden mb-2 relative">
                            <img :src="item.images.small" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition duration-300">
                            <div class="absolute top-1 right-1 w-6 h-6 bg-white/10 rounded-full flex items-center justify-center p-1 backdrop-blur-md">
                                <img :src="item.set.images.symbol" class="w-full h-full object-contain">
                            </div>
                            <div class="absolute bottom-0 inset-x-0 bg-black/90 text-center text-[#D4AF37] font-bold text-xs p-1 border-t border-[#333]">${{ getPrice(item) }}</div>
                        </div>
                        <div class="text-[10px] font-bold text-slate-300 truncate group-hover:text-white">{{ item.name }}</div>
                        <div class="flex justify-between items-center mt-1">
                             <div class="text-[9px] text-slate-500 uppercase truncate">#{{ item.number }}</div>
                             <div class="text-[9px] text-slate-600 uppercase">{{ item.rarity || 'Common' }}</div>
                        </div>
                    </div>
                </div>
                
                <div v-else-if="!loading && selectedSet && filteredResults.length === 0" class="flex flex-col items-center justify-center h-full text-slate-600 opacity-50">
                    <i class="fa-solid fa-ghost text-4xl mb-3"></i>
                    <p class="text-xs uppercase font-bold">No Pokemon Found</p>
                </div>
                
                <div v-else-if="!loading && !selectedSet" class="flex flex-col items-center justify-center h-full text-slate-700">
                    <div class="w-16 h-16 rounded-full bg-[#111] border border-[#222] flex items-center justify-center mb-4">
                        <i class="fa-solid fa-layer-group text-2xl text-[#333]"></i>
                    </div>
                    <p class="text-xs uppercase font-bold tracking-widest">Please Select Era & Set</p>
                </div>

            </div>
            
            <div class="p-2 bg-[#080808] border-t border-[#222] flex justify-between items-center text-[9px] text-slate-500 uppercase font-bold px-4">
                 <div>{{ filteredResults.length }} Cards Loaded</div>
                 <div>Data: PokemonTCG.io</div>
             </div>
        </div>
    </div>
    
    <input type="file" ref="restoreInput" @change="restore" class="hidden">
    
    <div class="md:hidden fixed bottom-0 inset-x-0 bg-[#080808] border-t border-[#222] p-2 flex justify-around z-30">
        <button @click="updatePrices" class="flex flex-col items-center text-slate-500 text-[10px]" :class="{'text-green-400': isUpdating}"><i class="fa-solid fa-arrows-rotate text-lg" :class="{'animate-spin': isUpdating}"></i> Update</button>
        <button @click="backup" class="flex flex-col items-center text-slate-500 text-[10px]"><i class="fa-solid fa-download text-lg"></i> Save</button>
        <button @click="restoreTrigger" class="flex flex-col items-center text-slate-500 text-[10px]"><i class="fa-solid fa-upload text-lg"></i> Load</button>
    </div>

</div>

<script>
    const { createApp } = Vue;

    // --- PRELOADED DATA STRUCTURE (INSTANT LOAD) ---
    // Organized by Era for the 3-Step logic
    const PRELOADED_SETS = [
        // 2025+ FUTURE / MEGA ERA
        {id: "sv8pt5", name: "Prismatic Evolutions", series: "Legends Z-A (Mega)", releaseDate: "2025/01/17", images: {symbol: "https://images.pokemontcg.io/sv8pt5/symbol.png"}},
        
        // SCARLET & VIOLET
        {id: "sv8", name: "Surging Sparks", series: "Scarlet & Violet", releaseDate: "2024/11/08", images: {symbol: "https://images.pokemontcg.io/sv8/symbol.png"}},
        {id: "sv7", name: "Stellar Crown", series: "Scarlet & Violet", releaseDate: "2024/09/13", images: {symbol: "https://images.pokemontcg.io/sv7/symbol.png"}},
        {id: "sv6pt5", name: "Shrouded Fable", series: "Scarlet & Violet", releaseDate: "2024/08/02", images: {symbol: "https://images.pokemontcg.io/sv6pt5/symbol.png"}},
        {id: "sv6", name: "Twilight Masquerade", series: "Scarlet & Violet", releaseDate: "2024/05/24", images: {symbol: "https://images.pokemontcg.io/sv6/symbol.png"}},
        {id: "sv5", name: "Temporal Forces", series: "Scarlet & Violet", releaseDate: "2024/03/22", images: {symbol: "https://images.pokemontcg.io/sv5/symbol.png"}},
        {id: "sv4pt5", name: "Paldean Fates", series: "Scarlet & Violet", releaseDate: "2024/01/26", images: {symbol: "https://images.pokemontcg.io/sv4pt5/symbol.png"}},
        {id: "sv4", name: "Paradox Rift", series: "Scarlet & Violet", releaseDate: "2023/11/03", images: {symbol: "https://images.pokemontcg.io/sv4/symbol.png"}},
        {id: "sv3pt5", name: "151", series: "Scarlet & Violet", releaseDate: "2023/09/22", images: {symbol: "https://images.pokemontcg.io/sv3pt5/symbol.png"}},
        {id: "sv3", name: "Obsidian Flames", series: "Scarlet & Violet", releaseDate: "2023/08/11", images: {symbol: "https://images.pokemontcg.io/sv3/symbol.png"}},
        {id: "sv2", name: "Paldea Evolved", series: "Scarlet & Violet", releaseDate: "2023/06/09", images: {symbol: "https://images.pokemontcg.io/sv2/symbol.png"}},
        {id: "sv1", name: "Scarlet & Violet Base", series: "Scarlet & Violet", releaseDate: "2023/03/31", images: {symbol: "https://images.pokemontcg.io/sv1/symbol.png"}},
        
        // SWORD & SHIELD
        {id: "swsh12pt5", name: "Crown Zenith", series: "Sword & Shield", releaseDate: "2023/01/20", images: {symbol: "https://images.pokemontcg.io/swsh12pt5/symbol.png"}},
        {id: "swsh12", name: "Silver Tempest", series: "Sword & Shield", releaseDate: "2022/11/11", images: {symbol: "https://images.pokemontcg.io/swsh12/symbol.png"}},
        {id: "swsh11", name: "Lost Origin", series: "Sword & Shield", releaseDate: "2022/09/09", images: {symbol: "https://images.pokemontcg.io/swsh11/symbol.png"}},
        {id: "swsh10", name: "Astral Radiance", series: "Sword & Shield", releaseDate: "2022/05/27", images: {symbol: "https://images.pokemontcg.io/swsh10/symbol.png"}},
        {id: "swsh9", name: "Brilliant Stars", series: "Sword & Shield", releaseDate: "2022/02/25", images: {symbol: "https://images.pokemontcg.io/swsh9/symbol.png"}},
        {id: "swsh8", name: "Fusion Strike", series: "Sword & Shield", releaseDate: "2021/11/12", images: {symbol: "https://images.pokemontcg.io/swsh8/symbol.png"}},
        {id: "swsh7", name: "Evolving Skies", series: "Sword & Shield", releaseDate: "2021/08/27", images: {symbol: "https://images.pokemontcg.io/swsh7/symbol.png"}},
        {id: "swsh6", name: "Chilling Reign", series: "Sword & Shield", releaseDate: "2021/06/18", images: {symbol: "https://images.pokemontcg.io/swsh6/symbol.png"}},
        
        // SUN & MOON
        {id: "sm12", name: "Cosmic Eclipse", series: "Sun & Moon", releaseDate: "2019/11/01", images: {symbol: "https://images.pokemontcg.io/sm12/symbol.png"}},
        {id: "sm115", name: "Hidden Fates", series: "Sun & Moon", releaseDate: "2019/08/23", images: {symbol: "https://images.pokemontcg.io/sm115/symbol.png"}},
        {id: "sm9", name: "Team Up", series: "Sun & Moon", releaseDate: "2019/02/01", images: {symbol: "https://images.pokemontcg.io/sm9/symbol.png"}},
        
        // XY
        {id: "xy12", name: "Evolutions", series: "XY", releaseDate: "2016/11/02", images: {symbol: "https://images.pokemontcg.io/xy12/symbol.png"}},
        {id: "xy7", name: "Ancient Origins", series: "XY", releaseDate: "2015/08/12", images: {symbol: "https://images.pokemontcg.io/xy7/symbol.png"}},

        // BLACK & WHITE
        {id: "bw11", name: "Legendary Treasures", series: "Black & White", releaseDate: "2013/11/06", images: {symbol: "https://images.pokemontcg.io/bw11/symbol.png"}},

        // CLASSIC
        {id: "base1", name: "Base Set", series: "Classic", releaseDate: "1999/01/09", images: {symbol: "https://images.pokemontcg.io/base1/symbol.png"}},
        {id: "base4", name: "Base Set 2", series: "Classic", releaseDate: "2000/02/24", images: {symbol: "https://images.pokemontcg.io/base4/symbol.png"}},
        {id: "gym1", name: "Gym Heroes", series: "Classic", releaseDate: "2000/08/14", images: {symbol: "https://images.pokemontcg.io/gym1/symbol.png"}}
    ];

    createApp({
        data() {
            return {
                cards: [], filter: '', showSearch: false, query: '', 
                rawSetData: [], loading: false, isUpdating: false,
                allSets: PRELOADED_SETS,
                
                // 3-STEP SELECTION STATE
                eras: ["Legends Z-A (Mega)", "Scarlet & Violet", "Sword & Shield", "Sun & Moon", "XY", "Black & White", "Classic"],
                selectedEra: "",
                selectedSet: ""
            }
        },
        mounted() {
            const db = localStorage.getItem('gladiator_v26');
            if(db) this.cards = JSON.parse(db);
            this.loadSetsBackground(); 
        },
        computed: {
            filteredCards() {
                if(!this.filter) return this.cards;
                return this.cards.filter(c => c.name.toLowerCase().includes(this.filter.toLowerCase()));
            },
            totalProfit() { return this.cards.reduce((sum, c) => sum + this.getProfit(c), 0); },
            
            // Step 2 Filter: Only show sets from Selected Era
            filteredSets() {
                if (!this.selectedEra) return [];
                return this.allSets.filter(s => s.series === this.selectedEra || (this.selectedEra === "Classic" && s.series === "Base"));
            },

            // Step 3 Filter: Filter the loaded set by query
            filteredResults() {
                let res = this.rawSetData;
                if(this.query) {
                    const q = this.query.toLowerCase();
                    res = res.filter(item => item.name.toLowerCase().includes(q) || item.number.includes(q));
                }
                // Sort by Number default for ease of finding
                return res.sort((a,b) => parseInt(a.number) - parseInt(b.number));
            }
        },
        watch: {
            // When user picks a set, download immediately
            selectedSet(newVal) {
                if(newVal) {
                    this.query = '';
                    this.fetchEntireSet(newVal);
                } else {
                    this.rawSetData = [];
                }
            },
            // Clear set selection if era changes
            selectedEra() { this.selectedSet = ""; this.rawSetData = []; }
        },
        methods: {
            formatNumber(n) { return (n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); },
            save() { localStorage.setItem('gladiator_v26', JSON.stringify(this.cards)); },
            
            getValue(c) {
                if(c.target == 10) return c.psa10;
                if(c.target == 9) return c.psa9;
                return c.psa8;
            },
            updateValue(c, newVal) {
                const v = parseFloat(newVal);
                if(c.target == 10) c.psa10 = v;
                else if(c.target == 9) c.psa9 = v;
                else c.psa8 = v;
                this.save();
            },
            getProfit(c) { return this.getValue(c) - ((c.raw || 0) + (c.fee || 0)); },

            // Background fetch to ensure we have ALL sets eventually, not just preloaded
            async loadSetsBackground() {
                try {
                    const res = await fetch('https://api.pokemontcg.io/v2/sets?select=id,name,series,releaseDate,images&orderBy=-releaseDate&pageSize=150');
                    const data = await res.json();
                    
                    // Smart Merge: Don't duplicate preloaded sets
                    const incoming = data.data;
                    const combined = [...this.allSets];
                    
                    incoming.forEach(inc => {
                        if(!combined.find(c => c.id === inc.id)) {
                            // Normalize series names if needed
                            if(inc.series === "Base") inc.series = "Classic"; 
                            combined.push(inc);
                        }
                    });
                    this.allSets = combined;
                } catch(e) { console.log("Background sync silent fail"); }
            },

            async fetchEntireSet(setId) {
                this.loading = true;
                this.rawSetData = [];
                try {
                    const fields = 'id,name,set,number,images,tcgplayer,rarity';
                    const url = `https://api.pokemontcg.io/v2/cards?q=set.id:${setId}&pageSize=250&select=${fields}&orderBy=number`; 
                    const res = await fetch(url);
                    const data = await res.json();
                    this.rawSetData = data.data || [];
                    this.$nextTick(() => this.$refs.searchBox.focus());
                } catch(e) {
                    alert("Error loading set. Check connection.");
                } finally { 
                    this.loading = false; 
                }
            },

            async updatePrices() {
                this.isUpdating = true;
                const cardsWithIds = this.cards.filter(c => c.id);
                const chunkSize = 20; 
                for (let i = 0; i < cardsWithIds.length; i += chunkSize) {
                    const chunk = cardsWithIds.slice(i, i + chunkSize);
                    const ids = chunk.map(c => `id:${c.id}`).join(' OR ');
                    try {
                        const res = await fetch(`https://api.pokemontcg.io/v2/cards?q=${ids}&select=id,tcgplayer`);
                        const data = await res.json();
                        data.data.forEach(apiCard => {
                            const match = this.cards.find(c => c.id === apiCard.id);
                            if(match) {
                                const newPrice = this.getPrice(apiCard);
                                if(newPrice > 0) {
                                    match.raw = newPrice;
                                    match.psa10 = parseFloat((newPrice * 3.2).toFixed(2));
                                    match.psa9 = parseFloat((newPrice * 1.1).toFixed(2));
                                    match.psa8 = parseFloat((newPrice * 0.85).toFixed(2));
                                }
                            }
                        });
                    } catch(e) {}
                }
                this.save();
                this.isUpdating = false;
                alert("Prices Updated!");
            },

            getPrice(item) {
                if(!item.tcgplayer?.prices) return 0;
                const p = item.tcgplayer.prices;
                return p.holofoil?.market || p.normal?.market || p.reverseHolofoil?.market || p.unlimitedHolofoil?.market || 0;
            },

            openSearch() { 
                this.showSearch = true; 
                this.selectedEra = ""; 
                this.selectedSet = ""; 
                this.query = ""; 
                this.rawSetData = []; 
            },
            
            add(item) {
                const rawPrice = this.getPrice(item);
                const newCard = {
                    id: item.id, name: item.name, set: item.set.name, img: item.images.small,
                    condition: '', raw: rawPrice, fee: 15, target: 10,
                    psa10: parseFloat((rawPrice * 3.2).toFixed(2)),
                    psa9: parseFloat((rawPrice * 1.1).toFixed(2)),
                    psa8: parseFloat((rawPrice * 0.85).toFixed(2)),
                };
                this.cards.push(newCard);
                this.save();
                this.showSearch = false;
            },
            
            remove(i) { if(confirm('Delete?')) { this.cards.splice(i,1); this.save(); } },
            
            exportExcel() {
                const data = this.cards.map(c => ({
                    Card: c.name, Set: c.set, Raw: c.raw, Cost: c.fee, 
                    Grade: c.target, Est_Value: this.getValue(c), Profit: this.getProfit(c)
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Gladiator");
                XLSX.writeFile(wb, "Gladiator_Export.xlsx");
            },
            exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont("helvetica", "bold"); doc.text("GLADIATOR REPORT", 14, 20);
                const rows = this.cards.map(c => [c.name, `$${c.raw}`, `$${c.fee}`, c.target, `$${this.getProfit(c).toFixed(0)}`, this.getProfit(c)>0?"YES":"NO"]);
                doc.autoTable({ startY: 30, head: [['Card', 'Raw', 'Cost', 'Grd', 'Profit', 'Dec']], body: rows });
                doc.save("Gladiator_Report.pdf");
            },
            backup() {
                const blob = new Blob([JSON.stringify(this.cards)], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "gladiator_backup.json"; a.click();
            },
            restoreTrigger() { this.$refs.restoreInput.click(); },
            restore(e) {
                const reader = new FileReader();
                reader.onload = e => { this.cards = JSON.parse(e.target.result); this.save(); };
                reader.readAsText(e.target.files[0]);
            }
        }
    }).mount('#app');
</script>
</body>
</html>
