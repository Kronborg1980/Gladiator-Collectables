<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gladiator | Auto-Analyzer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-dark: #09090b; --gold: #D4AF37; --border: #27272a; }
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: #e2e8f0; 
            background-image: radial-gradient(circle at 50% 0%, #1a1500 0%, #000 70%);
        }
        .font-brand { font-family: 'Cinzel', serif; }
        
        /* Glass Panel */
        .glass-panel { background: #121212; border: 1px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        /* Table Inputs */
        .input-cell { 
            background: transparent; border: 1px solid transparent; color: #ccc; 
            width: 100%; padding: 4px; font-size: 11px; transition: all 0.2s; font-family: monospace;
        }
        .input-cell:hover { background: #1a1a1a; border-color: #333; }
        .input-cell:focus { background: #000; border-color: var(--gold); outline: none; color: #fff; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body class="p-4 h-screen flex flex-col overflow-hidden">

<div id="app" v-cloak class="flex flex-col h-full w-full">
    
    <div class="flex justify-between items-center mb-4 px-2 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-yellow-900/20 p-2 rounded-lg border border-yellow-700/30">
                <i class="fa-solid fa-helmet-safety text-[#D4AF37] text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold font-brand text-white tracking-wide">GLADIATOR <span class="text-[#D4AF37]">AUTO-ANALYZER</span></h1>
                <div class="flex gap-4 text-[10px] text-slate-500 uppercase tracking-widest">
                    <span>{{ cards.length }} Assets</span>
                    <span class="text-green-500">Proj. Profit: ${{ formatNumber(totalProfit) }}</span>
                </div>
            </div>
        </div>

        <div class="flex gap-2">
            <div class="relative">
                <i class="fa-solid fa-search absolute left-2 top-1.5 text-slate-600 text-xs"></i>
                <input v-model="filter" placeholder="Filter List..." class="bg-[#111] border border-[#333] rounded pl-7 pr-3 py-1 text-xs w-48 focus:border-[#D4AF37] outline-none transition">
            </div>
            
            <button @click="exportExcel" class="bg-[#111] border border-[#333] text-green-500 px-3 py-1 rounded text-xs hover:bg-[#222] font-bold uppercase transition" title="Export Excel">
                <i class="fa-solid fa-file-excel mr-1"></i> Excel
            </button>
            
            <button @click="openSearch" class="bg-[#D4AF37] hover:bg-white text-black px-5 py-1 rounded text-xs font-bold uppercase transition shadow-lg shadow-yellow-900/20">
                <i class="fa-solid fa-plus mr-1"></i> Add Card
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-hidden glass-panel rounded-lg relative flex flex-col">
        <div class="overflow-auto flex-1">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 z-10 bg-[#000] shadow-xl">
                    <tr class="text-[10px] text-[#D4AF37] uppercase tracking-widest border-b border-[#333]">
                        <th class="p-3 bg-[#050505]">Card Info</th>
                        <th class="p-3 bg-[#050505] w-32">Condition</th>
                        <th class="p-3 bg-[#050505] text-right w-20">Raw $</th>
                        <th class="p-3 bg-[#050505] text-right w-20">Grade Fee</th>
                        <th class="p-3 bg-[#050505] text-center w-24">Exp. Grade</th>
                        
                        <th class="p-3 bg-[#0e0e0e] text-right w-24 border-l border-[#222] text-green-600">PSA 10</th>
                        <th class="p-3 bg-[#0e0e0e] text-right w-24 text-yellow-600">PSA 9</th>
                        <th class="p-3 bg-[#0e0e0e] text-right w-24 border-r border-[#222] text-red-600">PSA 8</th>

                        <th class="p-3 bg-[#050505] text-right w-24">Net Profit</th>
                        <th class="p-3 bg-[#050505] text-center w-24">Action</th>
                        <th class="p-3 bg-[#050505] w-24">Sent Date</th>
                        <th class="p-3 bg-[#050505] w-16 text-center">Owner</th>
                        <th class="p-3 bg-[#050505] w-10"></th>
                    </tr>
                </thead>
                <tbody class="text-xs divide-y divide-[#222]">
                    <tr v-for="(c, i) in filteredCards" :key="i" class="hover:bg-[#1a1a1a] group transition-colors">
                        
                        <td class="p-2 flex items-center gap-3 min-w-[200px]">
                            <img v-if="c.img" :src="c.img" class="w-8 h-11 object-cover rounded border border-[#333]">
                            <div>
                                <div class="font-bold text-slate-200 truncate w-40" :title="c.name">{{ c.name }}</div>
                                <div class="text-[9px] text-slate-500 uppercase">{{ c.set }}</div>
                            </div>
                        </td>

                        <td class="p-1"><input v-model="c.condition" type="text" placeholder="Mint..." class="input-cell text-slate-400"></td>

                        <td class="p-1"><input v-model.number="c.raw" type="number" class="input-cell text-right font-bold text-slate-300"></td>
                        <td class="p-1"><input v-model.number="c.fee" type="number" class="input-cell text-right text-slate-400"></td>

                        <td class="p-1 text-center">
                            <select v-model="c.target" class="bg-black border border-[#333] text-[#D4AF37] font-bold text-[10px] py-1 px-2 rounded cursor-pointer outline-none focus:border-[#D4AF37]">
                                <option value="10">PSA 10</option>
                                <option value="9">PSA 9</option>
                                <option value="8">PSA 8</option>
                            </select>
                        </td>

                        <td class="p-1 border-l border-[#222] bg-[#0c0c0c]"><input v-model.number="c.psa10" type="number" class="input-cell text-right text-green-500/90 font-bold"></td>
                        <td class="p-1 bg-[#0c0c0c]"><input v-model.number="c.psa9" type="number" class="input-cell text-right text-yellow-500/90 font-bold"></td>
                        <td class="p-1 border-r border-[#222] bg-[#0c0c0c]"><input v-model.number="c.psa8" type="number" class="input-cell text-right text-red-500/90 font-bold"></td>

                        <td class="p-2 text-right font-mono font-bold text-sm" :class="getProfit(c) >= 0 ? 'text-[#D4AF37]' : 'text-red-500'">
                            {{ getProfit(c) >= 0 ? '+' : '' }}{{ Math.round(getProfit(c)) }}
                        </td>

                        <td class="p-2 text-center">
                            <span v-if="getProfit(c) > 0" class="bg-green-900/30 text-green-400 border border-green-800 px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider">YES</span>
                            <span v-else class="bg-red-900/30 text-red-400 border border-red-800 px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider">NO</span>
                        </td>

                        <td class="p-1"><input v-model="c.sentDate" type="text" placeholder="-" class="input-cell text-center"></td>
                        <td class="p-1"><input v-model="c.owner" type="text" placeholder="-" class="input-cell text-center uppercase"></td>

                        <td class="p-1 text-center">
                            <button @click="remove(i)" class="text-slate-700 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div v-if="cards.length === 0" class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="text-center text-slate-700">
                <i class="fa-solid fa-magnifying-glass-chart text-4xl mb-3 opacity-20"></i>
                <p class="text-xs uppercase tracking-widest font-bold">No Assets Loaded</p>
                <p class="text-[10px] opacity-60 mt-1">Click "Add Card" to begin analysis</p>
            </div>
        </div>
    </div>

    <div v-if="showSearch" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-start justify-center pt-16 z-50 p-4 transition-all duration-300">
        <div class="w-full max-w-3xl bg-[#0a0a0a] border border-[#333] rounded-xl shadow-2xl flex flex-col max-h-[80vh] animate-in fade-in slide-in-from-bottom-4">
            
            <div class="p-4 border-b border-[#222] bg-[#0f0f0f] relative">
                <i class="fa-solid fa-search absolute left-8 top-1/2 -translate-y-1/2 text-slate-500"></i>
                <input ref="searchBox" v-model="query" 
                    placeholder="Search Card (e.g. 'Charizard 151' or 'Gengar VMAX')..." 
                    class="w-full bg-[#050505] border border-[#333] p-4 pl-12 text-[#D4AF37] font-mono text-lg outline-none rounded-lg focus:border-[#D4AF37] placeholder-slate-700 transition-colors">
                
                <button @click="showSearch=false" class="absolute right-6 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 bg-[#050505]">
                
                <div v-if="loading" class="text-center py-10 text-[#D4AF37]">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i>
                    <p class="text-xs uppercase tracking-widest">Scanning Database...</p>
                </div>

                <div v-else-if="results.length" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div v-for="item in results" :key="item.id" @click="add(item)" 
                         class="group cursor-pointer bg-[#111] border border-[#222] p-3 rounded-lg hover:border-[#D4AF37] hover:bg-[#161616] transition-all flex gap-3 items-start relative overflow-hidden">
                        
                        <img :src="item.images.small" class="w-16 h-22 object-cover rounded bg-black border border-[#333]">
                        
                        <div class="flex-1 min-w-0">
                            <div class="text-xs font-bold text-slate-200 truncate group-hover:text-white">{{ item.name }}</div>
                            <div class="text-[10px] text-slate-500 uppercase truncate mb-2">{{ item.set.name }}</div>
                            
                            <div class="inline-block bg-black/50 border border-[#333] px-2 py-1 rounded text-[#D4AF37] font-mono text-xs font-bold">
                                ${{ getPrice(item) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="query.length > 2" class="text-center py-12 text-slate-600">
                    <i class="fa-solid fa-ghost text-3xl mb-3 opacity-30"></i>
                    <p class="text-xs uppercase tracking-widest">No cards found.</p>
                    <p class="text-[10px] mt-1">Try typing just the Pok√©mon name (e.g. "Pikachu")</p>
                </div>
            </div>
            
            <div class="p-2 bg-[#0f0f0f] border-t border-[#222] text-center text-[10px] text-slate-600">
                Click a card to auto-populate Price & Grade Estimates.
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                cards: [], filter: '', showSearch: false, query: '', results: [], loading: false, timer: null
            }
        },
        mounted() {
            const db = localStorage.getItem('gladiator_v14');
            if(db) this.cards = JSON.parse(db);
        },
        computed: {
            filteredCards() {
                if(!this.filter) return this.cards;
                return this.cards.filter(c => c.name.toLowerCase().includes(this.filter.toLowerCase()));
            },
            totalProfit() { return this.cards.reduce((sum, c) => sum + this.getProfit(c), 0); }
        },
        watch: {
            query(val) {
                clearTimeout(this.timer);
                if(val.length < 3) { this.results = []; return; }
                this.loading = true;
                // Debounce 600ms to allow typing
                this.timer = setTimeout(() => this.fetchAPI(val), 600);
            }
        },
        methods: {
            formatNumber(n) { return (n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); },
            save() { localStorage.setItem('gladiator_v14', JSON.stringify(this.cards)); },
            
            // PROFIT CALCULATION
            getProfit(c) {
                let val = (c.target == 10) ? c.psa10 : (c.target == 9 ? c.psa9 : c.psa8);
                return (val || 0) - ((c.raw || 0) + (c.fee || 0));
            },

            // SMART SEARCH ENGINE
            async fetchAPI(input) {
                try {
                    // Split input into terms: "Charizard 151" -> ["Charizard", "151"]
                    const terms = input.trim().split(/\s+/);
                    
                    // Build flexible Lucene query: name must contain term OR set must contain term
                    // format: (name:"*term1*" OR set.name:"*term1*") (name:"*term2*" OR set.name:"*term2*")
                    const queryParts = terms.map(term => {
                        const t = term.replace(/[^a-zA-Z0-9]/g, ''); // Clean special chars
                        return `(name:"*${t}*" OR set.name:"*${t}*")`;
                    });
                    
                    const queryString = queryParts.join(' ');
                    const url = `https://api.pokemontcg.io/v2/cards?q=${queryString}&orderBy=-set.releaseDate&pageSize=20`;

                    const res = await fetch(url);
                    const data = await res.json();
                    this.results = data.data || [];
                } catch(e) {
                    console.error(e);
                } finally { 
                    this.loading = false; 
                }
            },

            // PRICE EXTRACTOR (Prioritizes Markets)
            getPrice(item) {
                if(!item.tcgplayer?.prices) return 0;
                const p = item.tcgplayer.prices;
                // Hierarchy: Holo > Normal > Reverse > 1stEd > Unlimited
                return p.holofoil?.market || p.normal?.market || p.reverseHolofoil?.market || p['1stEditionHolofoil']?.market || p.unlimitedHolofoil?.market || 0;
            },

            openSearch() { this.showSearch = true; this.query = ''; this.results = []; this.$nextTick(() => this.$refs.searchBox.focus()); },
            
            // AUTO-POPULATE LOGIC
            add(item) {
                const rawPrice = this.getPrice(item);
                
                // AUTOMATIC ESTIMATION ALGORITHM
                // Since API doesn't have graded prices, we estimate:
                // PSA 10 ~ 3.2x Raw
                // PSA 9  ~ 1.1x Raw
                // PSA 8  ~ 0.85x Raw
                
                const newCard = {
                    name: item.name, 
                    set: item.set.name,
                    img: item.images.small,
                    condition: 'NM', // Default
                    raw: rawPrice, 
                    fee: 15, // Default Grading Cost
                    target: 10, // Default Pre-Grade
                    
                    // Auto-Filled Estimates
                    psa10: parseFloat((rawPrice * 3.2).toFixed(2)),
                    psa9: parseFloat((rawPrice * 1.1).toFixed(2)),
                    psa8: parseFloat((rawPrice * 0.85).toFixed(2)),
                    
                    sentDate: '', 
                    owner: '', 
                    finalGrade: ''
                };
                
                this.cards.push(newCard);
                this.save();
                this.showSearch = false;
            },
            
            remove(i) { if(confirm('Delete Row?')) { this.cards.splice(i,1); this.save(); } },
            
            exportExcel() {
                const data = this.cards.map(c => ({
                    Card: c.name, Set: c.set, Raw_Price: c.raw, Grade_Cost: c.fee, 
                    Exp_Grade: c.target, PSA10: c.psa10, PSA9: c.psa9, PSA8: c.psa8,
                    Profit: this.getProfit(c), Decision: this.getProfit(c) > 0 ? "YES" : "NO"
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Gladiator Data");
                XLSX.writeFile(wb, "Gladiator_Export.xlsx");
            }
        }
    }).mount('#app');
</script>
</body>
</html>
