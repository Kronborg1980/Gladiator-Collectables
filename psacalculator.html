<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gladiator | Pro Dashboard</title>
    <link rel="icon" type="image/webp" href="https://raw.githubusercontent.com/Kronborg1980/Gladiator-Collectables/main/logogla.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --gold: #D4AF37; --border: #222; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #e2e8f0; height: 100vh; overflow: hidden; font-size: 12px; }
        .pro-input { background: transparent; border: 1px solid transparent; color: #ccc; width: 100%; padding: 1px 4px; font-size: 11px; }
        .pro-input:hover { background: #1a1a1a; border-color: #333; }
        .pro-input:focus { background: #000; border-color: var(--gold); outline: none; color: white; }
        .pro-input.number { font-family: monospace; font-weight: 600; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #080808; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="flex flex-col h-screen">
<div id="app" v-cloak class="flex flex-col h-full w-full">

    <!-- Header -->
    <div class="h-10 bg-[#0a0a0a] border-b border-[#222] flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/Kronborg1980/Gladiator-Collectables/main/logogla.webp" class="h-6 w-6">
            <span class="font-bold text-[#D4AF37] uppercase tracking-wider text-xs">Gladiator Pro</span>
        </div>
        <div class="flex items-center gap-6 text-[10px] font-mono text-slate-400">
            <div>ASSETS: <span class="text-white font-bold">{{ cards.length }}</span></div>
            <div class="hidden sm:block">COST: <span class="text-blue-400 font-bold">${{ formatNumber(totalCost) }}</span></div>
            <div>PROFIT: <span :class="totalProfit >= 0 ? 'text-green-400' : 'text-red-400'" class="font-bold">${{ formatNumber(totalProfit) }}</span></div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="p-2 bg-[#0e0e0e] border-b border-[#222] flex flex-wrap gap-2 items-center shrink-0">
        <div class="relative group">
            <i class="fa-solid fa-search absolute left-2 top-1.5 text-slate-600 text-[10px]"></i>
            <input v-model="filter" placeholder="FILTER..." class="bg-[#000] border border-[#222] text-white text-[10px] font-bold rounded pl-6 pr-2 py-1 w-32 focus:w-48 focus:border-[#D4AF37] outline-none transition-all uppercase">
        </div>
        <div class="h-4 w-[1px] bg-[#333] mx-1"></div>
        <button @click="updatePrices" :disabled="isUpdating" class="h-6 px-2 bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-green-400 border border-[#222] rounded text-[10px]" title="Update Prices">
            <i class="fa-solid fa-arrows-rotate" :class="{'animate-spin': isUpdating}"></i>
        </button>
        <button @click="exportExcel" class="h-6 px-2 bg-[#1a1a1a] hover:bg-[#222] text-green-500 border border-[#222] rounded text-[10px]"><i class="fa-solid fa-file-excel"></i></button>
        <button @click="backup" class="h-6 px-2 bg-[#1a1a1a] hover:bg-[#222] text-blue-500 border border-[#222] rounded text-[10px]"><i class="fa-solid fa-download"></i></button>
        <label class="h-6 px-2 bg-[#1a1a1a] hover:bg-[#222] text-purple-500 border border-[#222] rounded text-[10px] cursor-pointer flex items-center"><i class="fa-solid fa-upload"></i> <input type="file" @change="restore" class="hidden"></label>
        <div class="flex-1"></div>
        <button @click="openSearch" class="h-6 px-4 bg-[#D4AF37] hover:bg-white text-black font-bold uppercase rounded text-[10px] flex items-center gap-1"><i class="fa-solid fa-plus"></i> Add</button>
    </div>

    <!-- Desktop Table -->
    <div class="hidden md:block flex-1 overflow-hidden bg-[#050505]">
        <div class="absolute inset-0 overflow-auto">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 z-10 bg-[#0a0a0a] border-b border-[#333]">
                    <tr class="text-[9px] text-slate-500 uppercase tracking-widest h-8">
                        <th class="pl-2 w-8"></th>
                        <th class="px-2">Card Name</th>
                        <th class="px-2 w-32">Set</th>
                        <th class="px-2 w-24">Condition</th>
                        <th class="px-2 text-right w-16">Raw</th>
                        <th class="px-2 text-right w-16">Fee</th>
                        <th class="px-2 text-center w-16 text-[#D4AF37]">Target</th>
                        <th class="px-2 text-right w-20 text-white">Value</th>
                        <th class="px-2 text-right w-20">Profit</th>
                        <th class="px-2 text-center w-16">Act</th>
                        <th class="px-2 w-8"></th>
                    </tr>
                </thead>
                <tbody class="text-[11px] divide-y divide-[#151515]">
                    <tr v-for="(c, i) in filteredCards" :key="i" class="hover:bg-[#111] group h-8">
                        <td class="pl-2 py-0.5 text-center relative group/img">
                            <div class="w-5 h-7 bg-[#222] rounded border border-[#333] overflow-hidden"><img v-if="c.img" :src="c.img" class="w-full h-full object-cover"></div>
                            <div class="hidden group-hover/img:block absolute top-0 left-8 z-50 w-24 rounded border border-[#D4AF37] shadow-xl"><img v-if="c.img" :src="c.img"></div>
                        </td>
                        <td class="px-2 font-bold text-slate-300 truncate max-w-[150px]" :title="c.name">{{ c.name }}</td>
                        <td class="px-2 text-[10px] text-slate-500 truncate">{{ c.set }}</td>
                        <td class="px-2"><input v-model="c.condition" class="pro-input"></td>
                        <td class="px-2"><input v-model.number="c.raw" type="number" class="pro-input number text-right text-slate-400"></td>
                        <td class="px-2"><input v-model.number="c.fee" type="number" class="pro-input number text-right text-slate-500"></td>
                        <td class="px-2 text-center">
                            <select v-model="c.target" class="bg-transparent text-[#D4AF37] font-bold text-[10px] outline-none cursor-pointer">
                                <option value="10">10</option><option value="9">9</option><option value="8">8</option>
                            </select>
                        </td>
                        <td class="px-2"><input :value="getValue(c)" @input="updateValue(c,$event.target.value)" type="number" class="pro-input number text-right text-white font-bold bg-[#111] rounded px-1"></td>
                        <td class="px-2 text-right font-mono font-bold"><span :class="getProfit(c)>=0?'text-[#D4AF37]':'text-red-600'">{{ Math.round(getProfit(c)) }}</span></td>
                        <td class="px-2 text-center"><i v-if="getProfit(c)>0" class="fa-solid fa-check text-green-500 text-[10px]"></i><i v-else class="fa-solid fa-xmark text-red-500 text-[10px]"></i></td>
                        <td class="px-2"><button @click="remove(i)" class="text-slate-700 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-times"></i></button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div v-if="cards.length===0" class="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none">
            <h3 class="text-2xl font-bold text-slate-600 uppercase">Empty Armory</h3>
        </div>
    </div>

    <!-- Mobile Cards -->
    <div class="md:hidden flex-1 overflow-y-auto bg-[#050505] p-2 space-y-2">
        <div v-for="(c,i) in filteredCards" :key="i" class="bg-[#111] border border-[#222] rounded p-2 flex gap-3 items-center">
            <img v-if="c.img" :src="c.img" class="w-10 h-14 object-cover rounded border border-[#333]">
            <div class="flex-1 min-w-0">
                <div class="flex justify-between text-xs">
                    <div class="font-bold text-slate-200 truncate">{{ c.name }}</div>
                    <div class="font-mono font-bold" :class="getProfit(c)>=0?'text-green-400':'text-red-500'">${{ Math.round(getProfit(c)) }}</div>
                </div>
                <div class="text-[10px] text-slate-500">{{ c.set }}</div>
                <div class="flex gap-2 text-[10px] mt-1">
                    <span class="text-slate-600">Raw: ${{ c.raw }}</span>
                    <span class="text-[#D4AF37]">Val: ${{ getValue(c) }}</span>
                </div>
            </div>
            <button @click="remove(i)" class="text-slate-600"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <!-- SEARCH MODAL -->
    <div v-if="showSearch" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-start justify-center pt-8 z-50 p-4">
        <div class="w-full max-w-4xl bg-[#111] border border-[#222] rounded-lg shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-[#222] bg-[#0c0c0c] flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <h2 class="text-sm font-bold text-[#D4AF37] uppercase">Add Asset</h2>
                    <button @click="showSearch=false" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="flex gap-3 items-center">
                    <!-- Live Set Prediction -->
                    <div class="relative flex-1">
                        <input v-model="setQuery" @input="fetchSets" placeholder="Type set name..." class="w-full bg-black border border-[#333] text-white px-3 py-2 rounded text-xs uppercase outline-none focus:border-[#D4AF37]">
                        <div v-if="setSuggestions.length" class="absolute top-full left-0 right-0 bg-[#000] border border-[#333] max-h-48 overflow-y-auto z-10">
                            <div v-for="s in setSuggestions" :key="s.id" @click="selectSet(s)" class="px-3 py-1 hover:bg-[#222] cursor-pointer text-xs">
                                {{ s.name }} <span class="text-slate-500">({{ s.series }})</span>
                            </div>
                        </div>
                    </div>

                    <!-- Card Name -->
                    <input v-model="cardQuery" ref="cardBox" @keyup.enter="searchCards" placeholder="Card name..." class="flex-1 bg-black border border-[#333] text-white px-3 py-2 rounded text-xs uppercase outline-none focus:border-[#D4AF37]">

                    <button @click="searchCards" class="bg-[#D4AF37] hover:bg-white text-black px-6 py-2 rounded font-bold text-xs uppercase">SEARCH</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 bg-[#050505]">
                <div v-if="loading" class="text-center py-16 text-[#D4AF37]"><i class="fa-solid fa-circle-notch fa-spin text-3xl"></i></div>
                <div v-else-if="results.length" class="grid grid-cols-3 md:grid-cols-6 gap-3">
                    <div v-for="card in results" :key="card.id" @click="add(card)" class="bg-[#111] border border-[#222] rounded overflow-hidden hover:border-[#D4AF37] cursor-pointer transition">
                        <div class="aspect-[0.7] relative">
                            <img :src="card.image" loading="lazy" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 inset-x-0 bg-black/80 text-[#D4AF37] text-center font-bold text-xs py-1">
                                ${{ card.price || '???' }}
                            </div>
                        </div>
                        <div class="p-2 text-[9px]">
                            <div class="font-bold text-slate-300 truncate">{{ card.name }}</div>
                            <div class="text-slate-500 truncate">{{ card.set }} #{{ card.number }}</div>
                        </div>
                    </div>
                </div>
                <div v-else-if="hasSearched" class="text-center py-16 text-slate-600">No cards found</div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;
createApp({
    data() {
        return {
            cards: [],
            filter: '',
            showSearch: false,
            cardQuery: '',
            setQuery: '',
            selectedSetId: '',
            results: [],
            loading: false,
            hasSearched: false,
            setSuggestions: [],
            isUpdating: false
        }
    },
    mounted() {
        const saved = localStorage.getItem('gladiator_v28');
        if (saved) this.cards = JSON.parse(saved);
    },
    computed: {
        filteredCards() {
            if (!this.filter) return this.cards;
            const q = this.filter.toLowerCase();
            return this.cards.filter(c => c.name.toLowerCase().includes(q) || c.set.toLowerCase().includes(q));
        },
        totalCost() { return this.cards.reduce((s,c) => s + (c.raw||0) + (c.fee||0), 0); },
        totalProfit() { return this.cards.reduce((s,c) => s + this.getProfit(c), 0); }
    },
    methods: {
        formatNumber(n) { return (n||0).toLocaleString('en-US', {maximumFractionDigits: 0}); },
        save() { localStorage.setItem('gladiator_v28', JSON.stringify(this.cards)); },

        getValue(c) {
            if (c.target == 10) return c.psa10 || 0;
            if (c.target == 9) return c.psa9 || 0;
            return c.psa8 || 0;
        },
        updateValue(c, val) {
            const v = parseFloat(val) || 0;
            if (c.target == 10) c.psa10 = v;
            else if (c.target == 9) c.psa9 = v;
            else c.psa8 = v;
            this.save();
        },
        getProfit(c) { return this.getValue(c) - (c.raw||0) - (c.fee||0); },

        // Live set search (PriceCharting)
        async fetchSets() {
            if (this.setQuery.length < 2) {
                this.setSuggestions = [];
                this.selectedSetId = '';
                return;
            }
            try {
                const r = await fetch(`https://www.pricecharting.com/api/sets?q=${encodeURIComponent(this.setQuery)}&api_key=free`);
                const j = await r.json();
                this.setSuggestions = j.sets?.slice(0, 12) || [];
            } catch(e) { this.setSuggestions = []; }
        },
        selectSet(set) {
            this.setQuery = set.name;
            this.selectedSetId = set.id;
            this.setSuggestions = [];
            this.$refs.cardBox.focus();
        },

        // Super fast card search via PriceCharting
        async searchCards() {
            if (!this.cardQuery.trim()) return;
            this.loading = true;
            this.hasSearched = true;
            this.results = [];

            let url = `https://www.pricecharting.com/api/products?q=${encodeURIComponent(this.cardQuery)}&api_key=free`;
            if (this.selectedSetId) url += `&set_id=${this.selectedSetId}`;

            try {
                const r = await fetch(url);
                const j = await r.json();
                this.results = (j.products || []).map(p => ({
                    id: p.id,
                    name: p['product-name'],
                    set: p['console-name'],
                    number: p['item-number'] || '',
                    image: p['image-url'] || 'https://via.placeholder.com/200x280?text=No+Image',
                    price: p['price-1'] ? Math.round(parseFloat(p['price-1'])) : null
                }));
            } catch(e) {
                console.error(e);
                this.results = [];
            }
            this.loading = false;
        },

        add(card) {
            const price = card.price || 0;
            this.cards.push({
                id: card.id,
                name: card.name,
                set: card.set,
                img: card.image,
                raw: price,
                fee: 15,
                target: 10,
                psa10: +(price * 3.2).toFixed(2),
                psa9: +(price * 1.1).toFixed(2),
                psa8: +(price * 0.85).toFixed(2),
            });
            this.save();
            this.showSearch = false;
        },

        remove(i) {
            if (confirm('Delete?')) {
                this.cards.splice(i, 1);
                this.save();
            }
        },

        async updatePrices() {
            this.isUpdating = true;
            for (const c of this.cards) {
                if (!c.id) continue;
                try {
                    const r = await fetch(`https://www.pricecharting.com/api/product?t=${c.id}&api_key=free`);
                    const j = await r.json();
                    const newPrice = j['price-1'] ? Math.round(parseFloat(j['price-1'])) : c.raw;
                    c.raw = newPrice;
                    c.psa10 = +(newPrice * 3.2).toFixed(2);
                    c.psa9 = +(newPrice * 1.1).toFixed(2);
                    c.psa8 = +(newPrice * 0.85).toFixed(2);
                } catch(e) {}
            }
            this.save();
            this.isUpdating = false;
            alert('Prices updated!');
        },

        exportExcel() {
            const data = this.cards.map(c => ({
                Card: c.name, Set: c.set, Raw: c.raw, Fee: c.fee,
                Target: c.target, Value: this.getValue(c), Profit: this.getProfit(c)
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Gladiator");
            XLSX.writeFile(wb, "Gladiator_Export.xlsx");
        },

        backup() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(this.cards)], {type: 'application/json'}));
            a.download = 'gladiator_backup.json';
            a.click();
        },
        restore(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = e => { this.cards = JSON.parse(e.target.result); this.save(); };
            r.readAsText(f);
        },

        openSearch() {
            this.showSearch = true;
            this.cardQuery = '';
            this.setQuery = '';
            this.selectedSetId = '';
            this.results = [];
            this.hasSearched = false;
            this.$nextTick(() => this.$refs.cardBox?.focus());
        }
    }
}).mount('#app');
</script>
</body>
</html>
