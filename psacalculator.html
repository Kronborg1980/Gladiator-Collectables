<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gladiator | Pro Dashboard</title>
    <link rel="icon" type="image/webp" href="https://raw.githubusercontent.com/Kronborg1980/Gladiator-Collectables/main/logogla.webp">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #050505; --gold: #D4AF37; --border: #222; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #e2e8f0; height: 100vh; overflow: hidden; font-size: 12px; }
        
        /* COMPACT UI OVERRIDES */
        .glass-panel { background: #111; border: 1px solid #222; }
        
        /* Dense Inputs */
        .pro-input { background: transparent; border: 1px solid transparent; color: #ccc; width: 100%; padding: 1px 4px; font-size: 11px; }
        .pro-input:hover { background: #1a1a1a; border-color: #333; }
        .pro-input:focus { background: #000; border-color: var(--gold); outline: none; color: white; }
        .pro-input.number { font-family: monospace; font-weight: 600; letter-spacing: -0.5px; }

        /* TIGHT SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #080808; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        [v-cloak] { display: none; }
        .animate-spin-slow { animation: spin 2s linear infinite; }
    </style>
</head>
<body class="flex flex-col h-screen">

<div id="app" v-cloak class="flex flex-col h-full w-full">
    
    <div class="h-10 bg-[#0a0a0a] border-b border-[#222] flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/Kronborg1980/Gladiator-Collectables/main/logogla.webp" class="h-6 w-6 object-contain">
            <span class="font-bold text-[#D4AF37] uppercase tracking-wider text-xs">Gladiator Pro</span>
        </div>
        <div class="flex items-center gap-6 text-[10px] font-mono text-slate-400">
            <div>ASSETS: <span class="text-white font-bold">{{ cards.length }}</span></div>
            <div class="hidden sm:block">COST: <span class="text-blue-400 font-bold">${{ formatNumber(totalCost) }}</span></div>
            <div>PROFIT: <span :class="totalProfit >= 0 ? 'text-green-400' : 'text-red-400'" class="font-bold">${{ formatNumber(totalProfit) }}</span></div>
        </div>
    </div>

    <div class="p-2 bg-[#0e0e0e] border-b border-[#222] flex flex-wrap gap-2 items-center shrink-0">
        <div class="relative group">
            <i class="fa-solid fa-search absolute left-2 top-1.5 text-slate-600 text-[10px]"></i>
            <input v-model="filter" placeholder="FILTER..." class="bg-[#000] border border-[#222] text-white text-[10px] font-bold rounded pl-6 pr-2 py-1 w-32 focus:w-48 focus:border-[#D4AF37] outline-none transition-all uppercase">
        </div>
        <div class="h-4 w-[1px] bg-[#333] mx-1"></div>
        <button @click="updatePrices" :disabled="isUpdating" class="h-6 px-2 bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-green-400 border border-[#222] rounded text-[10px]" title="Update Prices"><i class="fa-solid fa-arrows-rotate" :class="{'animate-spin': isUpdating}"></i></button>
        <button @click="exportExcel" class="h-6 px-2 bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-green-500 border border-[#222] rounded text-[10px]" title="Excel"><i class="fa-solid fa-file-excel"></i></button>
        <button @click="backup" class="h-6 px-2 bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-blue-500 border border-[#222] rounded text-[10px]" title="Save"><i class="fa-solid fa-download"></i></button>
        <label class="h-6 px-2 bg-[#1a1a1a] hover:bg-[#222] text-slate-400 hover:text-purple-500 border border-[#222] rounded text-[10px] cursor-pointer flex items-center" title="Load"><i class="fa-solid fa-upload"></i> <input type="file" @change="restore" class="hidden"></label>
        <div class="flex-1"></div>
        <button @click="openSearch" class="h-6 px-4 bg-[#D4AF37] hover:bg-white text-black text-[10px] font-bold uppercase rounded flex items-center gap-1 shadow-sm"><i class="fa-solid fa-plus"></i> Add</button>
    </div>

    <div class="hidden md:block flex-1 overflow-hidden relative bg-[#050505]">
        <div class="absolute inset-0 overflow-auto">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 z-10 bg-[#0a0a0a] shadow-sm border-b border-[#333]">
                    <tr class="text-[9px] text-slate-500 uppercase tracking-widest h-8">
                        <th class="pl-2 w-8 text-center"></th>
                        <th class="px-2">Card Name</th>
                        <th class="px-2 w-32">Set</th>
                        <th class="px-2 w-24">Condition</th>
                        <th class="px-2 text-right w-16">Raw</th>
                        <th class="px-2 text-right w-16">Fee</th>
                        <th class="px-2 text-center w-16 text-[#D4AF37]">Target</th>
                        <th class="px-2 text-right w-20 text-white">Value</th>
                        <th class="px-2 text-right w-20">Profit</th>
                        <th class="px-2 text-center w-16">Act</th>
                        <th class="px-2 w-8"></th>
                    </tr>
                </thead>
                <tbody class="text-[11px] divide-y divide-[#151515]">
                    <tr v-for="(c, i) in filteredCards" :key="i" class="hover:bg-[#111] group h-8">
                        <td class="pl-2 py-0.5 text-center relative group/img">
                            <div class="w-5 h-7 bg-[#222] rounded border border-[#333] overflow-hidden"><img v-if="c.img" :src="c.img" class="w-full h-full object-cover"></div>
                            <div class="hidden group-hover/img:block absolute top-0 left-8 z-50 w-24 rounded border border-[#D4AF37] shadow-xl"><img v-if="c.img" :src="c.img" class="w-full h-full object-cover"></div>
                        </td>
                        <td class="px-2 font-bold text-slate-300 truncate max-w-[150px]" :title="c.name">{{ c.name }}</td>
                        <td class="px-2 text-[10px] text-slate-500 truncate max-w-[100px]">{{ c.set }}</td>
                        <td class="px-2"><input v-model="c.condition" class="pro-input"></td>
                        <td class="px-2"><input v-model.number="c.raw" type="number" class="pro-input number text-right text-slate-400"></td>
                        <td class="px-2"><input v-model.number="c.fee" type="number" class="pro-input number text-right text-slate-500"></td>
                        <td class="px-2 text-center"><select v-model="c.target" class="bg-transparent text-[#D4AF37] font-bold text-[10px] outline-none text-center p-0 cursor-pointer"><option value="10">10</option><option value="9">9</option><option value="8">8</option></select></td>
                        <td class="px-2"><input :value="getValue(c)" @input="updateValue(c, $event.target.value)" type="number" class="pro-input number text-right text-white font-bold bg-[#111] rounded px-1"></td>
                        <td class="px-2 text-right font-mono font-bold"><span :class="getProfit(c) >= 0 ? 'text-[#D4AF37]' : 'text-red-600'">{{ Math.round(getProfit(c)) }}</span></td>
                        <td class="px-2 text-center"><i v-if="getProfit(c) > 0" class="fa-solid fa-check text-green-500 text-[10px]"></i><i v-else class="fa-solid fa-xmark text-red-500 text-[10px]"></i></td>
                        <td class="px-2 text-center"><button @click="remove(i)" class="text-slate-700 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-times"></i></button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div v-if="cards.length === 0" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20"><h3 class="text-2xl font-brand font-bold text-slate-600 uppercase">Empty Armory</h3></div>
    </div>

    <div class="md:hidden flex-1 overflow-y-auto bg-[#050505] p-2 space-y-2">
        <div v-for="(c, i) in filteredCards" :key="i" class="bg-[#111] border border-[#222] rounded p-2 flex gap-3 items-center">
            <img v-if="c.img" :src="c.img" class="w-10 h-14 object-cover rounded border border-[#333]">
            <div class="flex-1 min-w-0">
                <div class="flex justify-between">
                    <div class="font-bold text-xs text-slate-200 truncate">{{ c.name }}</div>
                    <div class="font-mono font-bold text-xs" :class="getProfit(c) >= 0 ? 'text-green-400' : 'text-red-500'">${{ Math.round(getProfit(c)) }}</div>
                </div>
                <div class="text-[10px] text-slate-500 truncate">{{ c.set }}</div>
                <div class="flex gap-2 mt-1">
                    <div class="text-[10px] text-slate-600">Raw: ${{c.raw}}</div>
                    <div class="text-[10px] text-[#D4AF37]">Val: ${{ getValue(c) }}</div>
                </div>
            </div>
            <button @click="remove(i)" class="text-slate-600 px-2"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <div v-if="showSearch" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-start justify-center pt-4 z-50 p-2">
        <div class="w-full max-w-3xl bg-[#111] border border-[#222] rounded-lg shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-3 border-b border-[#222] bg-[#0c0c0c] flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <h2 class="text-sm font-bold text-[#D4AF37] uppercase">Add Asset</h2>
                    <button @click="showSearch=false" class="text-slate-500"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="flex gap-2">
                    <select v-model="selectedSet" class="bg-black border border-[#333] text-slate-300 text-[10px] font-bold rounded px-2 py-2 outline-none uppercase w-1/3 cursor-pointer">
                        <option value="">ALL SETS</option>
                        <optgroup label="Scarlet & Violet">
                            <option value="sv8pt5">Prismatic Evolutions</option>
                            <option value="sv8">Surging Sparks</option>
                            <option value="sv7">Stellar Crown</option>
                            <option value="sv6pt5">Shrouded Fable</option>
                            <option value="sv6">Twilight Masquerade</option>
                            <option value="sv5">Temporal Forces</option>
                            <option value="sv4pt5">Paldean Fates</option>
                            <option value="sv4">Paradox Rift</option>
                            <option value="sv3pt5">151</option>
                            <option value="sv3">Obsidian Flames</option>
                            <option value="sv2">Paldea Evolved</option>
                            <option value="sv1">S&V Base</option>
                        </optgroup>
                        <optgroup label="Sword & Shield">
                            <option value="swsh12pt5">Crown Zenith</option>
                            <option value="swsh12">Silver Tempest</option>
                            <option value="swsh11">Lost Origin</option>
                            <option value="pgo">Pokemon GO</option>
                            <option value="swsh10">Astral Radiance</option>
                            <option value="swsh9">Brilliant Stars</option>
                            <option value="swsh8">Fusion Strike</option>
                            <option value="cel25">Celebrations</option>
                            <option value="swsh7">Evolving Skies</option>
                            <option value="swsh6">Chilling Reign</option>
                            <option value="swsh5">Battle Styles</option>
                            <option value="swsh45">Shining Fates</option>
                            <option value="swsh4">Vivid Voltage</option>
                            <option value="swsh35">Champion's Path</option>
                            <option value="swsh3">Darkness Ablaze</option>
                            <option value="swsh2">Rebel Clash</option>
                            <option value="swsh1">SwSh Base</option>
                        </optgroup>
                        <optgroup label="Sun & Moon">
                            <option value="sm12">Cosmic Eclipse</option>
                            <option value="sm115">Hidden Fates</option>
                            <option value="sm11">Unified Minds</option>
                            <option value="sm10">Unbroken Bonds</option>
                            <option value="sm9">Team Up</option>
                        </optgroup>
                        <optgroup label="Vintage">
                            <option value="xy12">Evolutions</option>
                            <option value="base1">Base Set</option>
                            <option value="base2">Jungle</option>
                            <option value="base3">Fossil</option>
                            <option value="base4">Base Set 2</option>
                            <option value="base5">Team Rocket</option>
                        </optgroup>
                    </select>
                    
                    <input ref="searchBox" v-model="query" @keyup.enter="triggerSearch" placeholder="Name..." class="flex-1 bg-black border border-[#333] text-white rounded px-3 py-2 text-xs outline-none focus:border-[#D4AF37] uppercase">
                    
                    <button @click="triggerSearch" class="bg-[#D4AF37] hover:bg-white text-black px-4 py-2 rounded text-[10px] font-bold uppercase transition">
                        SEARCH
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2 bg-[#050505]">
                <div v-if="loading" class="text-center py-8 text-[#D4AF37] text-xs"><i class="fa-solid fa-circle-notch fa-spin"></i></div>
                <div v-else-if="results.length" class="grid grid-cols-3 md:grid-cols-5 gap-2">
                    <div v-for="item in results" :key="item.id" @click="add(item)" class="bg-[#111] border border-[#222] p-1 rounded hover:border-[#D4AF37] cursor-pointer group">
                        <div class="aspect-[0.7] bg-black rounded overflow-hidden mb-1 relative">
                            <img :src="item.images.small" loading="lazy" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 inset-x-0 bg-black/90 text-center text-[#D4AF37] font-bold text-[10px]">${{ getPrice(item) }}</div>
                        </div>
                        <div class="text-[9px] font-bold text-slate-300 truncate">{{ item.name }}</div>
                        <div class="text-[8px] text-slate-500 truncate">{{ item.set.name }} #{{ item.number }}</div>
                    </div>
                </div>
                <div v-else-if="hasSearched" class="text-center py-8 text-slate-600 text-xs">No cards found.</div>
            </div>
        </div>
    </div>
    
    <input type="file" ref="restoreInput" @change="restore" class="hidden">
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                cards: [], filter: '', showSearch: false, query: '', 
                results: [], loading: false, selectedSet: '', isUpdating: false, hasSearched: false
            }
        },
        mounted() {
            const db = localStorage.getItem('gladiator_v27');
            if(db) this.cards = JSON.parse(db);
        },
        computed: {
            filteredCards() {
                if(!this.filter) return this.cards;
                return this.cards.filter(c => c.name.toLowerCase().includes(this.filter.toLowerCase()));
            },
            totalCost() { return this.cards.reduce((sum, c) => sum + (c.raw || 0) + (c.fee || 0), 0); },
            totalProfit() { return this.cards.reduce((sum, c) => sum + this.getProfit(c), 0); }
        },
        methods: {
            formatNumber(n) { return (n||0).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0}); },
            save() { localStorage.setItem('gladiator_v27', JSON.stringify(this.cards)); },
            
            getValue(c) {
                if(c.target == 10) return c.psa10;
                if(c.target == 9) return c.psa9;
                return c.psa8;
            },
            updateValue(c, newVal) {
                const v = parseFloat(newVal);
                if(c.target == 10) c.psa10 = v;
                else if(c.target == 9) c.psa9 = v;
                else c.psa8 = v;
                this.save();
            },
            getProfit(c) { return this.getValue(c) - ((c.raw || 0) + (c.fee || 0)); },

            // --- MANUAL SEARCH LOGIC ---
            async triggerSearch() {
                // Prevent empty searches unless a set is selected
                if (!this.selectedSet && this.query.length < 2) return;

                this.loading = true;
                this.hasSearched = true;
                this.results = [];

                try {
                    let q = '';
                    
                    // Prefix Name Search
                    if (this.query.length >= 1) {
                        const terms = this.query.trim().split(/\s+/);
                        const nameQ = terms.map(t => `name:"${t.replace(/[^a-zA-Z0-9]/g, '')}*"`).join(' ');
                        q += nameQ;
                    }

                    // Strict Set Filter
                    if (this.selectedSet) {
                        q += ` set.id:${this.selectedSet}`;
                    }

                    const url = `https://api.pokemontcg.io/v2/cards?q=${q}&pageSize=24&orderBy=-set.releaseDate`; 
                    const res = await fetch(url);
                    const data = await res.json();
                    this.results = data.data || [];
                } catch(e) {
                    console.error(e);
                } finally { 
                    this.loading = false; 
                }
            },

            async updatePrices() {
                this.isUpdating = true;
                const cardsWithIds = this.cards.filter(c => c.id);
                const chunkSize = 12;
                for (let i = 0; i < cardsWithIds.length; i += chunkSize) {
                    const chunk = cardsWithIds.slice(i, i + chunkSize);
                    const ids = chunk.map(c => `id:${c.id}`).join(' OR ');
                    try {
                        const res = await fetch(`https://api.pokemontcg.io/v2/cards?q=${ids}`);
                        const data = await res.json();
                        data.data.forEach(apiCard => {
                            const match = this.cards.find(c => c.id === apiCard.id);
                            if(match) {
                                const newPrice = this.getPrice(apiCard);
                                match.raw = newPrice;
                                match.psa10 = parseFloat((newPrice * 3.2).toFixed(2));
                                match.psa9 = parseFloat((newPrice * 1.1).toFixed(2));
                                match.psa8 = parseFloat((newPrice * 0.85).toFixed(2));
                            }
                        });
                    } catch(e) {}
                }
                this.save();
                this.isUpdating = false;
                alert("Prices Updated!");
            },

            getPrice(item) {
                if(!item.tcgplayer?.prices) return 0;
                const p = item.tcgplayer.prices;
                return p.holofoil?.market || p.normal?.market || p.reverseHolofoil?.market || p.unlimitedHolofoil?.market || 0;
            },

            openSearch() { this.showSearch = true; this.query = ''; this.selectedSet = ''; this.results = []; this.hasSearched = false; this.$nextTick(() => this.$refs.searchBox.focus()); },
            
            add(item) {
                const rawPrice = this.getPrice(item);
                const newCard = {
                    id: item.id, name: item.name, set: item.set.name, img: item.images.small,
                    condition: '', raw: rawPrice, fee: 15, target: 10,
                    psa10: parseFloat((rawPrice * 3.2).toFixed(2)),
                    psa9: parseFloat((rawPrice * 1.1).toFixed(2)),
                    psa8: parseFloat((rawPrice * 0.85).toFixed(2)),
                };
                this.cards.push(newCard);
                this.save();
                this.showSearch = false;
            },
            
            remove(i) { if(confirm('Delete?')) { this.cards.splice(i,1); this.save(); } },
            
            exportExcel() {
                const data = this.cards.map(c => ({
                    Card: c.name, Set: c.set, Raw: c.raw, Cost: c.fee, 
                    Grade: c.target, Est_Value: this.getValue(c), Profit: this.getProfit(c)
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Gladiator");
                XLSX.writeFile(wb, "Gladiator_Export.xlsx");
            },
            exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont("helvetica", "bold"); doc.text("GLADIATOR REPORT", 14, 20);
                const rows = this.cards.map(c => [c.name, `$${c.raw}`, `$${c.fee}`, c.target, `$${this.getProfit(c).toFixed(0)}`, this.getProfit(c)>0?"YES":"NO"]);
                doc.autoTable({ startY: 30, head: [['Card', 'Raw', 'Cost', 'Grd', 'Profit', 'Dec']], body: rows });
                doc.save("Gladiator_Report.pdf");
            },
            backup() {
                const blob = new Blob([JSON.stringify(this.cards)], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "gladiator_backup.json"; a.click();
            },
            restoreTrigger() { this.$refs.restoreInput.click(); },
            restore(e) {
                const reader = new FileReader();
                reader.onload = e => { this.cards = JSON.parse(e.target.result); this.save(); };
                reader.readAsText(e.target.files[0]);
            }
        }
    }).mount('#app');
</script>
</body>
</html>
