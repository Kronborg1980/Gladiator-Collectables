<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gladiator Collectibles</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* GLADIATOR THEME */
        :root { --bg-color: #050505; --gold: #D4AF37; }
        
        body { 
            font-family: 'Lato', sans-serif; 
            background-color: var(--bg-color); 
            background-image: radial-gradient(circle at top center, #1a1a1a 0%, #000000 80%);
            color: #e2e8f0; 
        }
        
        h1, h2, h3, .brand { font-family: 'Cinzel', serif; }
        
        [v-cloak] { display: none; }

        .panel {
            background: rgba(18, 18, 18, 0.95);
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
        }

        .gold-text { 
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        input, select, textarea {
            background-color: #0a0a0a !important;
            border: 1px solid #333 !important;
            color: white !important;
            outline: none;
        }
        input:focus { border-color: var(--gold) !important; }
        
        .card-ratio { position: relative; padding-bottom: 139%; overflow: hidden; background: #111; border-radius: 4px; }
        .card-ratio img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

<div id="app" v-cloak class="max-w-[1800px] mx-auto">
    
    <input type="file" ref="fileInput" @change="handleImport" class="hidden" accept=".json">

    <div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-[#333] pb-6">
        <div>
            <h1 class="text-3xl md:text-5xl font-bold gold-text mb-2 uppercase tracking-wider">
                <i class="fa-solid fa-helmet-safety mr-3"></i>Gladiator
            </h1>
            <p class="text-slate-500 text-xs tracking-[0.3em] uppercase ml-1">Collectibles Manager</p>
        </div>
        <div class="flex gap-8 mt-6 md:mt-0">
            <div class="text-right">
                <div class="text-[10px] text-slate-500 uppercase">Count</div>
                <div class="text-2xl font-bold">{{ cards.length }}</div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-slate-500 uppercase">Profit</div>
                <div class="text-2xl font-bold" :class="totalProfit >= 0 ? 'text-[#D4AF37]' : 'text-red-500'">
                    ${{ formatNumber(totalProfit) }}
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-wrap gap-4 mb-6 justify-between items-center bg-[#0a0a0a] p-4 rounded border border-[#333]">
        <div class="relative w-full md:w-auto">
            <i class="fa-solid fa-search absolute left-3 top-3 text-slate-600"></i>
            <input type="text" v-model="search" placeholder="FILTER INVENTORY..." 
                class="pl-10 pr-4 py-2 w-full md:w-64 rounded-sm text-xs tracking-wider uppercase border border-[#333] focus:border-[#D4AF37]">
        </div>
        
        <div class="flex flex-wrap gap-2">
            <button @click="exportPDF" class="bg-[#111] hover:bg-[#222] border border-[#333] text-red-400 px-4 py-2 rounded-sm text-[10px] font-bold uppercase tracking-widest flex items-center gap-2 transition">
                <i class="fa-solid fa-file-pdf"></i> PDF
            </button>
            
            <button @click="exportExcel" class="bg-[#111] hover:bg-[#222] border border-[#333] text-green-500 px-4 py-2 rounded-sm text-[10px] font-bold uppercase tracking-widest flex items-center gap-2 transition">
                <i class="fa-solid fa-file-excel"></i> Excel
            </button>

            <div class="w-[1px] h-8 bg-[#333] mx-2"></div>

            <button @click="backupData" class="bg-[#111] hover:bg-[#222] border border-[#333] text-blue-400 px-4 py-2 rounded-sm text-[10px] font-bold uppercase tracking-widest flex items-center gap-2 transition">
                <i class="fa-solid fa-download"></i> Backup
            </button>

            <button @click="triggerImport" class="bg-[#111] hover:bg-[#222] border border-[#333] text-purple-400 px-4 py-2 rounded-sm text-[10px] font-bold uppercase tracking-widest flex items-center gap-2 transition">
                <i class="fa-solid fa-upload"></i> Restore
            </button>

            <button @click="openModal" class="ml-2 bg-[#D4AF37] hover:bg-white text-black px-6 py-2 rounded-sm font-bold tracking-wider uppercase flex items-center gap-2 shadow-lg hover:shadow-[#D4AF37]/50 transition text-xs">
                <i class="fa-solid fa-plus"></i> Add Card
            </button>
        </div>
    </div>

    <div class="panel rounded-lg overflow-hidden min-h-[400px]">
        <div v-if="cards.length === 0" class="p-20 text-center text-slate-600">
            <i class="fa-solid fa-box-open text-6xl mb-4"></i>
            <p class="text-sm uppercase tracking-widest">Inventory Empty</p>
        </div>

        <div v-else class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-black text-[#D4AF37] text-[10px] uppercase tracking-widest border-b border-[#333]">
                        <th class="p-4">Card</th>
                        <th class="p-4 text-right">Raw $</th>
                        <th class="p-4 text-center">Grade?</th>
                        <th class="p-4 text-right text-slate-500">PSA 10</th>
                        <th class="p-4 text-right text-white">Profit</th>
                        <th class="p-4 text-center">Status</th>
                        <th class="p-4"></th>
                    </tr>
                </thead>
                <tbody class="text-sm divide-y divide-[#222]">
                    <tr v-for="(card, index) in filteredCards" :key="index" class="hover:bg-[#1a1a1a] transition">
                        <td class="p-4 flex items-center gap-3">
                            <div class="w-8 h-12 bg-[#111] rounded overflow-hidden border border-[#333] shrink-0">
                                <img v-if="card.image" :src="card.image" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <div class="font-bold text-slate-200">{{ card.name }}</div>
                                <div class="text-[10px] text-slate-500 uppercase">{{ card.set }}</div>
                            </div>
                        </td>
                        <td class="p-4 text-right text-slate-400 font-mono">${{ card.raw }}</td>
                        <td class="p-4 text-center">
                            <select v-model="card.target" @change="save" class="bg-black border border-[#333] text-[#D4AF37] text-[10px] font-bold py-1 px-2 rounded cursor-pointer">
                                <option value="10">PSA 10</option>
                                <option value="9">PSA 9</option>
                                <option value="8">PSA 8</option>
                            </select>
                        </td>
                        <td class="p-4 text-right text-xs text-slate-600 font-mono">${{ card.psa10 }}</td>
                        <td class="p-4 text-right font-mono font-bold">
                            <span :class="getProfit(card) > 0 ? 'text-[#D4AF37]' : 'text-red-500'">
                                ${{ formatNumber(getProfit(card)) }}
                            </span>
                        </td>
                         <td class="p-4 text-center">
                             <select v-model="card.status" @change="save" class="bg-transparent text-[10px] text-slate-400 border-none cursor-pointer text-center uppercase tracking-wider">
                                <option value="Inventory">Inventory</option>
                                <option value="Grading">At PSA</option>
                                <option value="Sold">Sold</option>
                            </select>
                        </td>
                        <td class="p-4 text-right">
                            <button @click="remove(index)" class="text-slate-700 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-black/95 backdrop-blur-md flex items-center justify-center z-50 p-4">
        <div class="panel rounded-lg w-full max-w-4xl h-[90vh] flex flex-col relative overflow-hidden">
            <div class="p-4 border-b border-[#333] bg-[#0a0a0a] flex justify-between items-center shrink-0">
                <h2 class="text-xl text-[#D4AF37] brand uppercase">Search Database</h2>
                <div class="flex gap-4 items-center">
                    <button @click="enableManual" class="text-[10px] uppercase text-slate-500 hover:text-white underline">Manual Entry</button>
                    <button @click="showModal = false" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
            </div>
            
            <div v-if="!isManual && !selected" class="p-6 bg-[#0a0a0a] shrink-0 border-b border-[#333]">
                <input ref="searchInput" v-model="query" type="text" 
                    class="w-full p-4 text-lg text-[#D4AF37] font-mono border-b border-[#333] focus:border-[#D4AF37] placeholder-slate-700 bg-transparent" 
                    placeholder="TYPE POKEMON NAME (e.g. Pikachu)..." autofocus>
                <div class="mt-2 text-xs text-slate-500 flex justify-between">
                    <span>Searching automatically...</span>
                    <span v-if="loading" class="text-[#D4AF37]"><i class="fa-solid fa-circle-notch fa-spin"></i> Consulting Oracle...</span>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto bg-[#050505] p-6">
                <div v-if="!isManual && !selected">
                    <div v-if="results.length > 0" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div v-for="item in results" :key="item.id" @click="select(item)" 
                             class="group cursor-pointer bg-[#111] p-2 rounded border border-[#333] hover:border-[#D4AF37] hover:-translate-y-1 transition">
                            <div class="card-ratio mb-2 border border-black">
                                <img :src="item.images.small" loading="lazy">
                            </div>
                            <div class="text-xs font-bold text-slate-300 truncate">{{ item.name }}</div>
                            <div class="text-[10px] text-slate-500 uppercase">{{ item.set.name }}</div>
                        </div>
                    </div>
                </div>

                <div v-else class="max-w-2xl mx-auto animate-fade-in">
                    <button @click="reset" class="mb-4 text-xs text-slate-500 hover:text-white uppercase"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    <div class="flex gap-6 flex-col md:flex-row">
                        <div v-if="form.image" class="w-32 shrink-0 mx-auto">
                            <img :src="form.image" class="rounded border border-[#333] shadow-lg">
                        </div>
                        <div class="flex-1 space-y-4">
                            <div>
                                <label class="text-[10px] uppercase text-slate-500">Name</label>
                                <input v-model="form.name" class="w-full p-2 border border-[#333] rounded bg-black">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] uppercase text-slate-500">Raw Price</label>
                                    <input v-model.number="form.raw" type="number" class="w-full p-2 border border-[#333] rounded bg-black text-[#D4AF37]">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase text-slate-500">Grading Fee</label>
                                    <input v-model.number="form.fee" type="number" class="w-full p-2 border border-[#333] rounded bg-black">
                                </div>
                            </div>
                            <div class="p-4 bg-[#111] rounded border border-[#333]">
                                <div class="text-[10px] text-center text-slate-500 uppercase mb-2">Estimated Values</div>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div><label class="text-[9px] block text-green-500">PSA 10</label><input v-model.number="form.psa10" type="number" class="w-full p-1 bg-black border border-[#333] text-center text-xs"></div>
                                    <div><label class="text-[9px] block text-yellow-500">PSA 9</label><input v-model.number="form.psa9" type="number" class="w-full p-1 bg-black border border-[#333] text-center text-xs"></div>
                                    <div><label class="text-[9px] block text-red-500">PSA 8</label><input v-model.number="form.psa8" type="number" class="w-full p-1 bg-black border border-[#333] text-center text-xs"></div>
                                </div>
                            </div>
                            <button @click="add" class="w-full bg-[#D4AF37] hover:bg-white hover:text-black text-black font-bold py-3 rounded uppercase tracking-widest transition">Add to Inventory</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                search: '',
                cards: [],
                showModal: false,
                isManual: false,
                selected: false,
                loading: false,
                query: '',
                results: [],
                searchTimer: null, // Timer for debounce
                form: { name: '', raw: 0, fee: 20, target: 10, psa10: 0, psa9: 0, psa8: 0, image: '', set: '', status: 'Inventory' }
            }
        },
        mounted() {
            try {
                const data = localStorage.getItem('gladiator_db');
                if (data) this.cards = JSON.parse(data);
                if (!Array.isArray(this.cards)) this.cards = [];
            } catch (e) { this.cards = []; }
        },
        watch: {
            // Live Search Watcher with Debounce
            query(newVal) {
                clearTimeout(this.searchTimer);
                
                if (newVal.length < 3) {
                    this.results = [];
                    this.loading = false;
                    return;
                }

                this.loading = true;
                
                // Wait 500ms after user stops typing
                this.searchTimer = setTimeout(() => {
                    this.performSearch(newVal);
                }, 500);
            }
        },
        computed: {
            filteredCards() {
                if (!this.search) return this.cards;
                return this.cards.filter(c => c.name.toLowerCase().includes(this.search.toLowerCase()));
            },
            totalProfit() { return this.cards.reduce((acc, c) => acc + this.getProfit(c), 0); }
        },
        methods: {
            formatNumber(num) { return (num || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); },
            save() { localStorage.setItem('gladiator_db', JSON.stringify(this.cards)); },
            getProfit(c) {
                let val = (c.target == 10) ? c.psa10 : (c.target == 9 ? c.psa9 : c.psa8);
                return (val || 0) - ((c.raw || 0) + (c.fee || 0));
            },
            
            // EXPORT EXCEL
            exportExcel() {
                const ws = XLSX.utils.json_to_sheet(this.cards.map(c => ({
                    Name: c.name, Set: c.set, Raw_Cost: c.raw, Grade_Cost: c.fee, 
                    Target_Grade: c.target, PSA10: c.psa10, PSA9: c.psa9, 
                    Profit: this.getProfit(c), Status: c.status
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Inventory");
                XLSX.writeFile(wb, "Gladiator_Report.xlsx");
            },

            // EXPORT PDF
            exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont("helvetica", "bold");
                doc.text("GLADIATOR COLLECTIBLES REPORT", 14, 20);
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Total Items: ${this.cards.length} | Generated: ${new Date().toLocaleDateString()}`, 14, 28);

                const tableData = this.cards.map(c => [
                    c.name, c.set, `$${c.raw}`, c.target, `$${this.getProfit(c).toFixed(2)}`, c.status
                ]);

                doc.autoTable({
                    startY: 35,
                    head: [['Card Name', 'Set', 'Raw $', 'Grd', 'Profit', 'Status']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [212, 175, 55] } 
                });

                doc.save("Gladiator_Report.pdf");
            },

            // BACKUP (Save JSON)
            backupData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.cards));
                const node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "gladiator_backup.json");
                document.body.appendChild(node);
                node.click();
                node.remove();
            },

            // RESTORE (Import JSON)
            triggerImport() { this.$refs.fileInput.click(); },
            handleImport(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            if(confirm("Restore this backup? Current data will be replaced.")) {
                                this.cards = imported;
                                this.save();
                                alert("Database Restored Successfully!");
                            }
                        } else alert("Invalid Backup File");
                    } catch (err) { alert("Error reading file"); }
                };
                reader.readAsText(file);
                e.target.value = ''; 
            },

            // SEARCH LOGIC
            openModal() { 
                this.showModal = true; 
                this.reset();
                this.$nextTick(() => { if(this.$refs.searchInput) this.$refs.searchInput.focus(); });
            },
            reset() {
                this.isManual = false; this.selected = false; this.query = ''; this.results = [];
                this.form = { name: '', raw: 0, fee: 20, target: 10, psa10: 0, psa9: 0, psa8: 0, image: '', set: '', status: 'Inventory' };
            },
            enableManual() { this.isManual = true; this.selected = true; },
            
            async performSearch(queryText) {
                try {
                    // Sanitize Input (Remove quotes to prevent API errors)
                    const cleanQuery = queryText.replace(/[^a-zA-Z0-9 ]/g, '');
                    
                    const res = await fetch(`https://api.pokemontcg.io/v2/cards?q=name:"${cleanQuery}*"&orderBy=-set.releaseDate&pageSize=20`);
                    
                    if (!res.ok) throw new Error("API Limit");
                    
                    const data = await res.json();
                    this.results = data.data || [];
                } catch (e) {
                    // Silent fail for rate limits, but stop loading
                    console.log("Search paused or limit reached");
                } finally {
                    this.loading = false;
                }
            },
            
            select(item) {
                this.selected = true;
                let price = 0;
                if (item.tcgplayer?.prices) {
                    const p = item.tcgplayer.prices;
                    price = p.holofoil?.market || p.normal?.market || p.reverseHolofoil?.market || 0;
                }
                this.form = {
                    name: item.name, raw: price, fee: 20, target: 10,
                    psa10: parseFloat((price * 3.2).toFixed(2)), psa9: parseFloat((price * 1.1).toFixed(2)), psa8: parseFloat((price * 0.8).toFixed(2)),
                    image: item.images.small, set: item.set.name, status: 'Inventory'
                };
            },
            add() { this.cards.push({...this.form}); this.save(); this.showModal = false; },
            remove(i) { if (confirm("Delete this card?")) { this.cards.splice(i, 1); this.save(); } }
        }
    }).mount('#app');
</script>

</body>
</html>
